<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>æ€ æƒ°äº†</title>
    <url>/2020/05/28/other/</url>
    <content><![CDATA[<p>å‡†å¤‡æŠŠè¿‘äº›å¹´çš„é¡¹ç›®ã€ç¬”è®°ã€æ–‡æ¡£ã€ppt, æ•´ç†ä¸€ä¸‹å†™å†™åšå®¢; <br><br>ç„¶è€Œå‘ç°å½“å¹´é€‰çš„åšå®¢ä¸»é¢˜å¥½ä¸‘å•Š, è€Œä¸”è¿™ä¸ªç›®å½•ä»€ä¹ˆé¬¼, ä¸ºä»€ä¹ˆæ²¡æœ‰å­ç›®å½•, è€Œä¸”ç•™è¨€è²Œä¼¼ä¹Ÿä¸èƒ½ç”¨äº†; <br><br>ç®—äº†, å°±è¿™æ ·å§ ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>
]]></content>
      <categories>
        <category>other</category>
      </categories>
      <tags>
        <tag>other</tag>
      </tags>
  </entry>
  <entry>
    <title>promise ç®€å•å®ç°</title>
    <url>/2018/01/27/promise-simple/</url>
    <content><![CDATA[<p>Promises/A+è§„èŒƒçš„ç®€å•å®ç°, çº¯ä»£ç <br><a id="more"></a></p>
<p>çœ‹äº†ä¸€ä¸‹å…¶ä»–çš„, æ„Ÿè§‰å’Œæˆ‘çš„ä¸å¤ªä¸€æ ·å•Š ğŸ˜‚ ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ <br><br>æœ‰æ—¶é—´ä»”ç»†ç ”ç©¶ä¸‹æ€ä¹ˆå›äº‹</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> states = &#123;</span><br><span class="line">  pending: <span class="string">'Pending'</span>,</span><br><span class="line">  resolved: <span class="string">'Resolved'</span>,</span><br><span class="line">  rejected: <span class="string">'Rejected'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = states.pending</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.thenHandlers = &#123;</span><br><span class="line">      onResolve: <span class="literal">null</span>,</span><br><span class="line">      onReject: <span class="literal">null</span>,</span><br><span class="line">      childResolve: <span class="literal">null</span>,</span><br><span class="line">      childReject: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      fn(<span class="keyword">this</span>._resolve.bind(<span class="keyword">this</span>), <span class="keyword">this</span>._reject.bind(<span class="keyword">this</span>))</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="comment">// å¤„ç† fn æŠ¥é”™</span></span><br><span class="line">      <span class="keyword">this</span>._reject(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _resolve (value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value === <span class="keyword">this</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'TypeError'</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === states.rejected) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// value is object(... or promise) function</span></span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; (<span class="keyword">typeof</span> value === <span class="string">'object'</span> || <span class="keyword">typeof</span> value === <span class="string">'function'</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> then = value.then</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="comment">// éµå¾ª value-promise çš„çŠ¶æ€æµè½¬, å°†å½“å‰çš„ this.thenHandler å¤„ç†æ”¾åœ¨ value-then ä¸­å¤„ç†</span></span><br><span class="line">        <span class="comment">//! ä¸€å®šè¦ä¸è¦å¿˜è®° _reject å‡½æ•°, ä¸ç„¶å½“ value-promise ä¸­æŠ¥é”™ä¸”æ²¡æœ‰ catch å‡½æ•°æ—¶, å°†ä¼šæ— æ³•æ•æ‰</span></span><br><span class="line">        then.call(value, <span class="keyword">this</span>._resolve.bind(<span class="keyword">this</span>), <span class="keyword">this</span>._reject.bind(<span class="keyword">this</span>))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// ç¡®ä¿ onResolve, onReject å¤„ç†éƒ½åœ¨ä¸‹ä¸€ä¸ªæ—¶é—´å¾ªç¯ä¸­</span></span><br><span class="line">      <span class="keyword">this</span>.state = states.resolved</span><br><span class="line">      <span class="keyword">this</span>._handle(</span><br><span class="line">        <span class="keyword">this</span>.thenHandlers.onResolve,</span><br><span class="line">        <span class="keyword">this</span>.thenHandlers.childResolve,</span><br><span class="line">        value</span><br><span class="line">      )</span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _handle (cb, childCb, res) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!childCb) <span class="keyword">return</span> <span class="comment">// promise é“¾åˆ°æ­¤ä¸ºæ­¢</span></span><br><span class="line">    <span class="keyword">if</span> (!cb || <span class="keyword">typeof</span> cb !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="comment">// æ²¡æœ‰æä¾› onResolve/onReject, æˆ–è€…ä¸æ˜¯å‡½æ•°, å€¼ç©¿é€</span></span><br><span class="line">      childCb(res)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res2 = cb(res)</span><br><span class="line">      <span class="keyword">this</span>.thenHandlers.childResolve(res2)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">this</span>.thenHandlers.childReject(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _reject (err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === states.resolved) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    err = err || <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'promise rejected'</span>)</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// ç¡®ä¿ çŠ¶æ€å˜æ›´, onResolve, onReject å¤„ç†éƒ½åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­, æ–¹ä¾¿ then catch çš„èµ‹å€¼</span></span><br><span class="line">      <span class="keyword">this</span>.state = states.rejected</span><br><span class="line">      <span class="comment">// æ³¨æ„è¿™ä¸ª onReject</span></span><br><span class="line">      <span class="comment">// æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ then (onResolve, onReject), æ˜¯ä¸ä¼šæä¾› onReject å‡½æ•°çš„</span></span><br><span class="line">      <span class="comment">// è¿™ç§æƒ…å†µ, åœ¨ _handle ä¸­, å°±ç›´æ¥è·³è¿‡å¤„ç†äº†</span></span><br><span class="line">      <span class="comment">// console.log('this thenhandler onRject ====&gt; ', this.thenHandlers)</span></span><br><span class="line">      <span class="keyword">this</span>._handle(</span><br><span class="line">        <span class="keyword">this</span>.thenHandlers.onReject,</span><br><span class="line">        <span class="keyword">this</span>.thenHandlers.childReject,</span><br><span class="line">        err</span><br><span class="line">      )</span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">catch</span> (onError) &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†æŠ¥é”™, æœ¬è´¨è¿˜æ˜¯ then, ä»…æä¾›å‰é¢æµç¨‹ä¸­å¯¹ reject æŠ›é”™çš„æ¥æ”¶å‡½æ•°</span></span><br><span class="line">    <span class="comment">// æ³¨æ„: onError æ¥æ”¶åˆ°çš„æ˜¯ err ä¿¡æ¯, å¦‚æœåœ¨ onError ä¸­ä¸ç»§ç»­ throw çš„è¯, å°†ä¼šè¿›å…¥ resolve æµç¨‹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.then(<span class="literal">null</span>, onError)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  then (onResolve, onReject) &#123;</span><br><span class="line">    <span class="comment">// è¦æ±‚è¿”å› promise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// æ—¢ç„¶è¿”å›äº†æ–°å®ä¾‹, é‚£å°±åœ¨å½“å‰å®ä¾‹ resolve/reject åè°ƒç”¨å­å®ä¾‹çš„ resolve/reject</span></span><br><span class="line">      <span class="comment">// å³å®ä¾‹åµŒå¥—, å½“å‰å®ä¾‹è°ƒç”¨å­å®ä¾‹çš„ (child)resolve, (child)reject å‡½æ•°</span></span><br><span class="line">      <span class="keyword">this</span>.thenHandlers.onResolve = onResolve</span><br><span class="line">      <span class="keyword">this</span>.thenHandlers.onReject = onReject</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.thenHandlers.childResolve = resolve</span><br><span class="line">      <span class="keyword">this</span>.thenHandlers.childReject = reject</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">finally</span> (fn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!fn || <span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">return</span> <span class="keyword">this</span>.then()</span><br><span class="line">    <span class="comment">// å’Œ callback ç±»ä¼¼, ä¸åŒçš„æ˜¯ä¸çŸ¥é“çŠ¶æ€, ä¸æ¥å—å‚æ•°, ä¿ç•™åŸè¾“å‡ºæˆ–æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.then(</span><br><span class="line">      v =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> MyPromise.resolve(fn()).then(<span class="function"><span class="params">()</span> =&gt;</span> v)</span><br><span class="line">      &#125;,</span><br><span class="line">      e =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> MyPromise.resolve(fn()).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> e</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> resolve (value) &#123;</span><br><span class="line">    <span class="comment">// if (value instanceof MyPromise) return value</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> value.then === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> then = value.then</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        then(resolve)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function"><span class="params">resolve</span> =&gt;</span> (value ? resolve(value) : resolve()))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> reject (value) &#123;</span><br><span class="line">    <span class="comment">// if (value instanceof MyPromise) return value</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> value.then === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="comment">// thenable</span></span><br><span class="line">      <span class="keyword">const</span> then = value.then</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        then(reject)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value = value || <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'promise rejected'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> reject(value))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å‚è€ƒï¼š <a href="https://www.ituring.com.cn/article/66566" target="_blank" rel="noopener">ã€ç¿»è¯‘ã€‘Promises/A+è§„èŒƒ</a></p>
</blockquote>
]]></content>
      <categories>
        <category>promise</category>
      </categories>
      <tags>
        <tag>promise</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2017/12/16/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<a id="more"></a>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
      <categories>
        <category>test</category>
      </categories>
      <tags>
        <tag>test</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo-next</title>
    <url>/2017/12/23/hexo-next/</url>
    <content><![CDATA[<h2 id="ä½¿ç”¨-hexo-next-æ­å»º-github-pages-æ³¨æ„äº‹é¡¹"><a href="#ä½¿ç”¨-hexo-next-æ­å»º-github-pages-æ³¨æ„äº‹é¡¹" class="headerlink" title="ä½¿ç”¨ hexo - next æ­å»º github pages æ³¨æ„äº‹é¡¹"></a>ä½¿ç”¨ hexo - next æ­å»º github pages æ³¨æ„äº‹é¡¹</h2><p><code>next version</code>ï¼š <code>5.1.3</code></p>
<p>æ–‡ä»¶å†…å®¹åªæ˜¯ä¸€äº›æ¯”è¾ƒç¢çš„æ³¨æ„äº‹é¡¹ï¼Œ è¯¦ç»†æµç¨‹è¯·å‚ç…§ï¼š <a href="http://theme-next.iissnan.com/" target="_blank" rel="noopener">next å®˜ç½‘</a><br><a id="more"></a></p>
<h3 id="1-æ›´æ¢-next-ä¸»é¢˜"><a href="#1-æ›´æ¢-next-ä¸»é¢˜" class="headerlink" title="1. æ›´æ¢ next ä¸»é¢˜"></a>1. æ›´æ¢ next ä¸»é¢˜</h3><figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>hexo init site_name <span class="comment"># åˆ›å»ºä½ çš„ hexo é¡¹ç›®ç›®å½•</span></span><br><span class="line"><span class="variable">$ </span>cd site_name</span><br><span class="line"><span class="variable">$ </span>git clone <span class="symbol">https:</span>/<span class="regexp">/github.com/iissnan</span><span class="regexp">/hexo-theme-next themes/next</span> <span class="comment"># ä¸‹è½½ä¸»é¢˜</span></span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œé¡¹ç›®ç›®å½•ä¸‹æœ‰ä¸¤ä¸ª _config.yml é…ç½®æ–‡ä»¶ï¼š</p>
<ol>
<li>./_config.yml                       # <code>ç«™ç‚¹é…ç½®æ–‡ä»¶</code></li>
<li>./themes/next/_config.yml # <code>ä¸»é¢˜é…ç½®æ–‡ä»¶</code><br>ç„¶åä¿®æ”¹<code>ç«™ç‚¹é…ç½®æ–‡ä»¶</code> <strong>theme: next</strong> å³å¯</li>
</ol>
<h3 id="2-éƒ¨ç½²é¡¹ç›®è‡³-your-user-name-github-io"><a href="#2-éƒ¨ç½²é¡¹ç›®è‡³-your-user-name-github-io" class="headerlink" title="2.  éƒ¨ç½²é¡¹ç›®è‡³ your_user_name.github.io"></a>2.  éƒ¨ç½²é¡¹ç›®è‡³ your_user_name.github.io</h3><p>é¦–å…ˆï¼Œ åœ¨ <code>github</code> åˆ›å»ºåä¸º <code>your_user_name.github.io</code> çš„é¡¹ç›®<br>ç„¶åï¼Œ åœ¨ <code>ç«™ç‚¹é…ç½®æ–‡ä»¶</code> åŠ å…¥æˆ–é…ç½®</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="attribute">deploy</span>:</span><br><span class="line">  <span class="attribute">type</span>: git</span><br><span class="line">  <span class="attribute">branch</span>: master</span><br><span class="line">  <span class="attribute">repo</span>: <span class="attribute">https</span>:<span class="comment">//github.com/your_user_name/your_user_name.github.io.git</span></span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œ å¼€å§‹å°† hexo é¡¹ç›®æ¨è‡³ github pages</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line">$ hexo clean</span><br><span class="line">$ hexo <span class="keyword">generate</span></span><br><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<h3 id="3-åŸŸåé…ç½®"><a href="#3-åŸŸåé…ç½®" class="headerlink" title="3. åŸŸåé…ç½®"></a>3. åŸŸåé…ç½®</h3><p>ä¸¤ç§æ–¹æ¡ˆï¼š</p>
<blockquote>
<p>æ–¹æ¡ˆä¸€ï¼š åœ¨ your_user_name.github.io é¡¹ç›®ä¸­ç‚¹å‡» <code>setting</code>, é…ç½® custom domain ï¼ˆç¼ºç‚¹ï¼š æ¯æ¬¡ deploy éœ€è¦é‡æ–°é…ç½®ï¼‰<br>æ–¹æ¡ˆäºŒï¼š åœ¨ hexo é¡¹ç›® source ç›®å½•ä¸‹ï¼Œ åˆ›å»º CNAME æ–‡ä»¶å­˜å‚¨åŸŸå</p>
</blockquote>
<h3 id="4-é™æ€æ–‡ä»¶å­˜æ”¾"><a href="#4-é™æ€æ–‡ä»¶å­˜æ”¾" class="headerlink" title="4. é™æ€æ–‡ä»¶å­˜æ”¾"></a>4. é™æ€æ–‡ä»¶å­˜æ”¾</h3><p>ç”±äºæ¯æ¬¡ deploy éƒ½ä¼šç”Ÿæˆæ–°çš„ ./.deploy æ–‡ä»¶å¤¹å¹¶æ¨é€è‡³è¿œç«¯ï¼Œæ‰€ä»¥ç±»ä¼¼ imagesã€CNAMEã€README æ–‡ä»¶éƒ½è¦æ”¾åœ¨ source æ–‡ä»¶å¤¹ä¸‹ï¼Œ å¦åˆ™å°†ä¸ä¼šæ¨é€è‡³è¿œç«¯ã€‚</p>
<h3 id="5-æ–‡ä»¶å†…å®¹å¤´è¯´æ˜"><a href="#5-æ–‡ä»¶å†…å®¹å¤´è¯´æ˜" class="headerlink" title="5. æ–‡ä»¶å†…å®¹å¤´è¯´æ˜"></a>5. æ–‡ä»¶<code>å†…å®¹å¤´</code>è¯´æ˜</h3><p>åœ¨æ¯ç¯‡æ–‡ç« çš„å¤´éƒ¨éƒ½ä¼šæœ‰è¯´æ˜ä¿¡æ¯ä¾›è§£æï¼Œ ä¸å¤šè¯´ï¼Œ çœ‹ç¤ºä¾‹<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">Hello</span> <span class="string">World</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2017</span><span class="number">-12</span><span class="number">-16</span></span><br><span class="line"><span class="attr">categories:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">tags:</span> <span class="string">[test]</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<h3 id="6-é¦–é¡µ-read-more-è®¾ç½®"><a href="#6-é¦–é¡µ-read-more-è®¾ç½®" class="headerlink" title="6. é¦–é¡µ read more è®¾ç½®"></a>6. é¦–é¡µ <code>read more</code> è®¾ç½®</h3><p>åœ¨ *.md æ–‡ä»¶ä¸­åŠ å…¥ <code>&lt;!-- more --&gt;</code>ï¼Œ è‡ªç”±æ§åˆ¶æ˜¾ç¤ºå†…å®¹ï¼Œ å…¶ä»–æ–¹å¼ä¸åšæ¨èï¼Œä¸åšä»‹ç»</p>
<h3 id="7-è¯­è¨€è®¾ç½®"><a href="#7-è¯­è¨€è®¾ç½®" class="headerlink" title="7. è¯­è¨€è®¾ç½®"></a>7. è¯­è¨€è®¾ç½®</h3><p>è¯­è¨€è®¾ç½®æœ€å¥½è®¾ç½®å›ºå®šè¯­è¨€ï¼ˆä¸ªäººæ¨èï¼‰ï¼Œ å®æµ‹å¦‚æœä¸è®¾ç½®ï¼Œå¯èƒ½ä¼šå‡ºç°ä¹±ä¸ƒå…«æ§½çš„è¯­è¨€ï¼›<br><code>ç«™ç‚¹é…ç½®æ–‡ä»¶</code><br><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">language</span>: <span class="keyword">en</span></span><br></pre></td></tr></table></figure></p>
<h3 id="8-gitment"><a href="#8-gitment" class="headerlink" title="8. gitment"></a>8. gitment</h3><p>é¦–å…ˆï¼Œ åœ¨ github <a href="https://github.com/settings/applications/new" target="_blank" rel="noopener">developer setting</a>  <code>Register a new OAuth application</code><br><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">application name <span class="meta"># éšæ„</span></span><br><span class="line">Homepage URL <span class="meta"># https:<span class="comment">//your_user_name.github.io || custom domain</span></span></span><br><span class="line">Authorization callback URL <span class="meta"># https:<span class="comment">//your_user_name.github.io || custom domain</span></span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>å…¶ä¸­ï¼Œ ä¸¤ä¸ª URL è§†éœ€æ±‚è€Œå®šï¼Œ æš‚ä¸æ”¯æŒå¤šURLï¼›<br>åˆ›å»ºåä¼šç”Ÿæˆ client_idã€client_secret ä¾›ä½¿ç”¨</p>
</blockquote>
<p>ç„¶åï¼Œ åˆ›å»º ä¸€ä¸ªé¡¹ç›® <code>gitment-comments</code> ï¼Œ é¡¹ç›®åéšæ„ï¼Œ ä¸‹é¢é…ç½®ä¼šç”¨åˆ°ï¼Œç”¨æ¥å­˜å‚¨å›å¤å†…å®¹ï¼›<br>æœ€åï¼Œ åœ¨ <code>ä¸»é¢˜é…ç½®æ–‡ä»¶</code>ä¸­é…ç½®ï¼š<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">gitment:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mint:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">count:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">lazy:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">cleanly:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">language:</span> <span class="comment"># Force language, or auto switch by theme</span></span><br><span class="line">  <span class="attr">github_user:</span> <span class="comment"># your user name</span></span><br><span class="line">  <span class="attr">github_repo:</span> <span class="string">gitment-comments</span> <span class="comment"># å­˜å‚¨å›å¤å†…å®¹çš„é¡¹ç›®åç§°</span></span><br><span class="line">  <span class="attr">client_id:</span> <span class="comment"># client_id</span></span><br><span class="line">  <span class="attr">client_secret:</span> <span class="comment"># client_secet</span></span><br><span class="line">  <span class="attr">proxy_gateway:</span> <span class="comment"># Address of api proxy, See: https://github.com/aimingoo/intersect</span></span><br><span class="line">  <span class="attr">redirect_protocol:</span> <span class="comment"># Protocol of redirect_uri with force_redirect_protocol when mint enabled</span></span><br></pre></td></tr></table></figure></p>
<h3 id="9-æœç´¢åŠŸèƒ½æ¨è"><a href="#9-æœç´¢åŠŸèƒ½æ¨è" class="headerlink" title="9. æœç´¢åŠŸèƒ½æ¨è"></a>9. æœç´¢åŠŸèƒ½æ¨è</h3><p>æœ¬æ–‡ç« æ¨èä½¿ç”¨ local search</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">$ npm <span class="keyword">install</span> hexo-generator-searchdb --save <span class="comment"># å®‰è£…æ’ä»¶</span></span><br></pre></td></tr></table></figure>
<p><code>ç«™ç‚¹é…ç½®æ–‡ä»¶</code>ï¼ˆä¸åšè§£é‡Šï¼‰ï¼š<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">format:</span> <span class="string">html</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure></p>
<p><code>ä¸»é¢˜é…ç½®æ–‡ä»¶</code>ï¼š<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># if auto, trigger search by changing input</span></span><br><span class="line">  <span class="comment"># if manual, trigger search by pressing enter key or search button</span></span><br><span class="line">  <span class="attr">trigger:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment"># show top n results per article, show all results by setting to -1</span></span><br><span class="line">  <span class="attr">top_n_per_article:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql Connector</title>
    <url>/2020/05/28/debezium/mysql/</url>
    <content><![CDATA[<p>connector ä½œä¸º slave è¿æ¥ mysql, æ¥æ”¶ è¡Œçº§ binary log, å®ç°æ•°æ®å˜æ›´äº‹ä»¶é€šçŸ¥</p>
<blockquote>
<p>connector å·¥ä½œæµç¨‹å¦‚ä¸‹</p>
</blockquote>
<ul>
<li><ol>
<li>snapshot record (åˆå§‹åŒ–)</li>
</ol>
<ul>
<li>å¯¹æ•°æ®åº“ åŠ å…¨å±€åªè¯»é” åšå¿«ç…§è¯», å¯¹éœ€è¦ç›‘æ§çš„æ•°æ®åº“ schema å’Œ æ•°æ®åšåŒæ­¥</li>
</ul>
</li>
<li><ol start="2">
<li>binlog record</li>
</ol>
</li>
</ul>
<a id="more"></a>
<h3 id="1-Mysql-é…ç½®"><a href="#1-Mysql-é…ç½®" class="headerlink" title="1. Mysql é…ç½®"></a>1. Mysql é…ç½®</h3><ul>
<li>binlog_format<ul>
<li><code>row level</code>: show variables like â€˜binlog_formatâ€™;</li>
</ul>
</li>
<li>version<ul>
<li><code>5.6 or later</code>: select version()</li>
</ul>
</li>
<li>GTID å¯é€‰</li>
<li>åˆ›å»ºç‰¹å®šç”¨æˆ·<ul>
<li>æƒé™: GRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, REPLICATION CLIENT, LOCK TABLES ON _._ TO â€˜debeziumâ€™ IDENTIFIED BY â€˜dbzâ€™;</li>
<li>select: æŸ¥æ‰¾è¡Œ; <code>ä»… snapshot éœ€è¦</code></li>
<li>reload: flush å‘½ä»¤éœ€è¦; <code>ä»… snapshot éœ€è¦</code></li>
<li>show databases: è·å–æ‰€æœ‰ database åç§°; <code>ä»… snapshot éœ€è¦</code></li>
<li>replication slave: connect and read binlog; <code>æ€»æ˜¯éœ€è¦</code></li>
<li>replication client: SHOW MASTER STATUS, SHOW SLAVE STATUS, and SHOW BINARY LOGS; <code>æ€»æ˜¯éœ€è¦</code></li>
<li>LOCK TABLES: è¡¨çº§é”; <code>ä»… aws éœ€è¦ä¸”åŠ é”æ—¶éœ€è¦</code></li>
</ul>
</li>
<li>mysql ä¸åŒæ¶æ„<ul>
<li>å•æœº: æ²¡é—®é¢˜</li>
<li>ä¸»ä»å¤åˆ¶: connector è¿æ¥ä¸€å°å®ä¾‹, å¹¶ä¸”ä¸€ç›´è¿æ¥è¿™å°å®ä¾‹; ä¸åŒå®ä¾‹çš„ binlog ä½ç½®è®°å½•ä¸åŒ, æ‰€ä»¥ä¸å¯èƒ½åˆ‡æ¢å®ä¾‹</li>
</ul>
</li>
<li>mysql æ•°æ®åº“åï¼Œè¡¨å: ([a-z,A-Z,0-9,_])</li>
</ul>
<h3 id="2-connector-å‚æ•°"><a href="#2-connector-å‚æ•°" class="headerlink" title="2. connector å‚æ•°"></a>2. connector å‚æ•°</h3><ul>
<li>name: å”¯ä¸€åç§°</li>
<li>connector.class: è¿æ¥å™¨çš„ java class, å¦‚æœ connect ä¸­æ²¡æœ‰å†…ç½®è¯¥è¿æ¥å™¨, éœ€è¦å¦è¡Œä¸‹è½½ã€å®‰è£…è¯¥æ’ä»¶</li>
<li>tasks.max: é»˜è®¤ä¸º 1, mysql ä¸èƒ½æ”¹</li>
<li>database.hostname: ..</li>
<li>database.port: ..</li>
<li>database.user: å‰é¢æåˆ°çš„<code>ç‰¹å®šç”¨æˆ·</code></li>
<li>database.password: ..</li>
<li>database.whitelist: é€—å·åˆ†éš”ç™½åå•, å’Œ blacklist æ— æ³•å…±å­˜</li>
<li>database.blacklist: é€—å·åˆ†éš”é»‘åå•, å’Œ whitelist æ— æ³•å…±å­˜</li>
<li>table.whitelist: .., å’Œ blacklist æ— æ³•å…±å­˜</li>
<li>table.blacklist: .., å’Œ whitelist æ— æ³•å…±å­˜</li>
<li>database.server.name:<ul>
<li>å­—æ¯æˆ–ä¸‹åˆ’çº¿å¼€å¤´</li>
<li>mysql é›†ç¾¤ä¸­çš„å”¯ä¸€æœåŠ¡å;</li>
<li>ä½œä¸ºæ•°æ®å­˜å‚¨çš„ kafka topic çš„å‰ç¼€ (${server.name}.${db_name}.\${table_name})</li>
</ul>
</li>
<li>database.server.id:<ul>
<li>mysql é›†ç¾¤ä¸­å”¯ä¸€æœåŠ¡ id</li>
<li>ä½œä¸º slave åŒæ­¥ mysql binary log, æ‰€ä»¥å’Œå…¶ä»– mysql slave ä¹Ÿè¦åŒºåˆ†</li>
</ul>
</li>
<li>database.history.kafka.bootstrap.servers: kafka åœ°å€ (é€—å·åˆ†éš”)</li>
<li>database.history.kafka.topic: mysql schema å˜æ›´è®°å½• topic<ul>
<li>ç›®å‰ä¸ºæ°¸ä¸åˆ é™¤</li>
</ul>
</li>
<li>database.history.store.only.monitored.tables.ddl: true or false<ul>
<li>æ˜¯å¦ç›‘æ§å…¶ä½™è¡¨çš„ schema å˜åŒ–å¹¶å­˜å‚¨</li>
<li>é˜¿é‡Œäº‘ rds æœ‰æœ¬èº«çš„å¥åº·å—…æ¢è¡¨, ä¼šä¸åœçš„ç”Ÿæˆ ddl è¯­å¥, ç”±äº <code>history topic</code> ä¸ä¼šåˆ é™¤, ä¼šå¯¼è‡´æ•°æ®ç´¯ç§¯ã€‚<ul>
<li>mysql.ha_health_check</li>
<li>ä»»åŠ¡é‡å¯æ—¶, ä¼šå°† schema æ‹‰åˆ°æœ¬åœ°, åšæ•°æ®å¤„ç†.</li>
<li>å¦‚æœä¸åœç´¯ç§¯, å°†ä¼šå½±å“æ‹‰å–ä»¥åŠå¤„ç†çš„è€—æ—¶, å¯¼è‡´å…¶ä»–ä¸€ç³»åˆ—ä¹±ä¸ƒå…«ç³Ÿçš„é—®é¢˜</li>
</ul>
</li>
<li>æ‰€ä»¥, å»ºè®®è®¾ç½®ä¸º true, åªç›‘æ§ table.whitelist ä¸­ schema å˜æ›´</li>
</ul>
</li>
<li>snapshot.mode: snapshot ç±»å‹<ul>
<li>é»˜è®¤(initial)ä¼šå°†æ•°æ®åº“ schema å’Œ æ‰€æœ‰æ•°æ®ç”Ÿæˆ create äº‹ä»¶, ä¼ å…¥ kafka;</li>
<li>æˆ‘ä»¬é€‰æ‹© schema_only(åªåŒæ­¥ schema)</li>
</ul>
</li>
<li>snapshot.locking.mode<ul>
<li>æ˜¯å¦æŒæœ‰å…¨å±€è¯»é”</li>
<li>innotdb ä¸‹, å…¨å±€é”å’Œä¸€è‡´æ€§è¯»éƒ½å¯ä»¥ç”¨æ¥å¤‡ä»½, è€Œæºç ä¸­ä¸¤è€…é‡åˆäº†, æ‰€ä»¥è¯¥é€‰é¡¹å¯ä»¥è®¾ä¸º none</li>
</ul>
</li>
<li>snapshot.new.tables: parallel<ul>
<li>ä½¿å¾—æ›´æ”¹ table.whitlist æ“ä½œç”Ÿæ•ˆ</li>
<li>è²Œä¼¼æ˜¯ <code>beta</code> å‚æ•°, æ¸©æŸ”ä¿®æ”¹ç™½\é»‘åå•, ä¸ç„¶ä¼šç»æœ›çš„</li>
</ul>
</li>
<li>decimal.handling.mode: string<ul>
<li>decimal/numberic é»˜è®¤è½¬ä¸º bytes, æš‚å¤„ç†ä¸º string, æ›´æ˜“è¯»ã€å¤„ç†</li>
</ul>
</li>
<li>gtid.new.channel.position: (new channel å³ GTID å‰ç¼€å‘ç”Ÿå˜åŒ–, ä¸»è¦å‘ç”Ÿåœ¨ master æ•…éšœè½¬ç§»è‡³å…¶ä»– slave, å¯¼è‡´å½“å‰ slave æ”¶åˆ°ä¿¡æ¯çš„ GTID å‘ç”Ÿå˜åŒ–)<ul>
<li>latest (default): å³å½“ debezium å†æ¬¡è¿æ¥æ—¶(è‹¥åˆ‡æ¢ master ä¹‹é—´æš‚åœæˆ–æ–­å¼€)ä»æœ€æ–°ä½ç½®å¼€å§‹åŒæ­¥æ•°æ®</li>
<li>earliest: è¯»å–<code>æ–°</code> GTID ä¸”æœªè¢«æ¸…ç†çš„æ‰€æœ‰æ•°æ®</li>
</ul>
</li>
</ul>
<blockquote>
<p>ç¤ºä¾‹å¦‚ä¸‹</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"connector.class"</span>: <span class="string">"io.debezium.connector.mysql.MySqlConnector"</span>,</span><br><span class="line">    <span class="attr">"snapshot.locking.mode"</span>: <span class="string">"none"</span>,</span><br><span class="line">    <span class="attr">"database.user"</span>: <span class="string">"debezium"</span>,</span><br><span class="line">    <span class="attr">"database.server.id"</span>: <span class="string">"222333221"</span>,</span><br><span class="line">    <span class="attr">"tasks.max"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"database.history.kafka.bootstrap.servers"</span>: <span class="string">"192.168.4.22:9092"</span>,</span><br><span class="line">    <span class="attr">"database.history.kafka.topic"</span>: <span class="string">"history_inventory_1"</span>,</span><br><span class="line">    <span class="attr">"database.server.name"</span>: <span class="string">"mysql_inventory_1"</span>,</span><br><span class="line">    <span class="attr">"database.port"</span>: <span class="string">"3306"</span>,</span><br><span class="line">    <span class="attr">"table.whitelist"</span>: <span class="string">"inventory.orders"</span>,</span><br><span class="line">    <span class="attr">"decimal.handling.mode"</span>: <span class="string">"string"</span>,</span><br><span class="line">    <span class="attr">"database.hostname"</span>: <span class="string">"192.168.4.23"</span>,</span><br><span class="line">    <span class="attr">"database.password"</span>: <span class="string">"dbz"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"mysql_inventory_1"</span>,</span><br><span class="line">    <span class="attr">"database.history.store.only.monitored.tables.ddl"</span>: <span class="string">"true"</span>,</span><br><span class="line">    <span class="attr">"database.whitelist"</span>: <span class="string">"inventory"</span>,</span><br><span class="line">    <span class="attr">"snapshot.mode"</span>: <span class="string">"schema_only"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-å¯åŠ¨æµç¨‹"><a href="#3-å¯åŠ¨æµç¨‹" class="headerlink" title="3. å¯åŠ¨æµç¨‹"></a>3. å¯åŠ¨æµç¨‹</h3><ul>
<li><p>snapshot</p>
<ul>
<li>åŠŸèƒ½:<ul>
<li><ol>
<li>è®¾ç½® session ä¸‹ REPEATABLE READ éš”ç¦»çº§åˆ« å’Œå…¨å±€é” (aws å…¨å±€é”å¤±è´¥ï¼Œé’ˆå¯¹ç™½åå•ï¼ŒåŠ è¡¨çº§è¯»é”)</li>
</ol>
<ul>
<li><code>snapshot.locking.mode: none</code> è·³è¿‡åŠ é”</li>
</ul>
</li>
<li><ol start="2">
<li>start transaction with consistent snapshot å¿«ç…§è¯»äº‹åŠ¡: æ˜¾ç¤ºå¼€å¯å¿«ç…§, è€Œä¸æ˜¯åƒä¸€èˆ¬æƒ…å†µä¸‹, ç¬¬ä¸€æ¬¡ select å¼€å¯å¿«ç…§è¯»</li>
</ol>
</li>
<li><ol start="3">
<li>binglog æ–‡ä»¶åå’Œ positionã€gtid ç­‰è·å–</li>
</ol>
</li>
<li><ol start="4">
<li>å®ä¾‹ä¸‹æ•°æ®åº“åˆ—è¡¨è·å–</li>
</ol>
</li>
<li><ol start="5">
<li>æ¯ä¸ªåº“çš„è¡¨åˆ—è¡¨è·å–</li>
</ol>
</li>
<li><ol start="6">
<li>connect é…ç½®ç™½åå•æ•°æ®åº“çš„ drop create è¯­å¥å¯¼å…¥ kafka ç‰¹å®š topic</li>
</ol>
</li>
<li><ol start="7">
<li>å…¨å±€é”æ—¶è§£é”</li>
</ol>
<ul>
<li>unlock tables åœ¨é’ˆå¯¹å…¨å±€ï¼Œä¸ä¼šéšå¼æäº¤</li>
<li>é’ˆå¯¹ lock table æ—¶ï¼Œä¼šè§¦å‘éšå¼æäº¤</li>
</ul>
</li>
<li><ol start="8">
<li>å¯¹æ¯ä¸ªè¡¨è¿›è¡Œæ‰«æï¼Œå¹¶å¯¹æ¯è¡Œæ•°æ®ç”Ÿæˆ create äº‹ä»¶ï¼Œå¯¼å…¥ kafka</li>
</ol>
<ul>
<li>å¯é€šè¿‡ <code>snapshot.mode: schema_only</code> æ¥è·³è¿‡æ­¤æ­¥éª¤</li>
</ul>
</li>
<li><ol start="9">
<li>commit</li>
</ol>
</li>
<li><ol start="10">
<li>å†æ¬¡è§£é”(ä¸»è¦é’ˆå¯¹è¡¨çº§é”)</li>
</ol>
</li>
</ul>
</li>
<li><p>æ³¨æ„:</p>
<ul>
<li><ol>
<li>é»˜è®¤æƒ…å†µä¸‹å…¨å±€é”, å½“æ— æ³•è·å¾—å…¨å±€é”(æ¯”å¦‚ aws rds)æ—¶, ä¼šå¯¹æ¯ä¸ªè¡¨åˆ†åˆ«åŠ è¡¨çº§è¯»é”ã€‚</li>
</ol>
</li>
<li><ol start="2">
<li>ä½†æ˜¯è¡¨çº§é”çš„ unlock å‘½ä»¤ä¼šåšéšå¼äº‹åŠ¡æäº¤ï¼Œå¯¼è‡´ æ­¥éª¤ 8 å’Œ ä¸Šé¢æ­¥éª¤ä¸åœ¨åŒä¸€äº‹åŠ¡ä¸­ã€‚</li>
</ol>
</li>
<li><ol start="3">
<li>é‚£ä¹ˆæ­¤æ—¶çš„æ­¥éª¤ 8 å°±è„±ç¦»äº†å¿«ç…§è¯»çš„èŒƒå›´ï¼Œæ­¤æ—¶å¦‚æœæœ‰æ•°æ®æ’å…¥:</li>
</ol>
<ul>
<li>ä¸€æ–¹é¢ä¼šè¢«æ­¥éª¤ 8 æ•°æ®æ‰«æ, åˆ›å»º create äº‹ä»¶è¿›å…¥ kafka;</li>
<li>å¦ä¸€æ–¹é¢ï¼Œä¼šåœ¨æ­¥éª¤ 3 è·å–çš„ binlog ä½ç½®åé¢æ’å…¥ create è®°å½•, ç„¶åç­‰åˆ° connector å¿«ç…§æ¨¡å¼å®Œæˆ è¿›å…¥ binglog åŒæ­¥æ¨¡å¼ï¼Œå°±ä¼šç”Ÿæˆ Create äº‹ä»¶ï¼Œå¯¼è‡´é‡å¤ã€‚ï¼ˆæˆ–è€…åˆ é™¤æ“ä½œï¼Œbinlog åˆ é™¤æ—¶ï¼ŒæŒ‡å‘äº†ä¸€ä¸ªä¸å­˜åœ¨çš„ id ç­‰ï¼‰</li>
</ul>
</li>
<li><ol start="4">
<li>æ‰€ä»¥è¡¨çº§é”çš„è§£é”æ”¾åœ¨äº‹åŠ¡æäº¤åï¼Œè¿™æ ·å¦‚æœæ•°æ®åº“å¾ˆå¤§ï¼Œå°±æœ‰çš„ç­‰äº†</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="4-æ·»åŠ -table-whitelist"><a href="#4-æ·»åŠ -table-whitelist" class="headerlink" title="4. æ·»åŠ  table.whitelist"></a>4. æ·»åŠ  table.whitelist</h3><ul>
<li>æ—§æ–¹æ³•:<ul>
<li><ol>
<li>add table</li>
</ol>
</li>
<li><ol start="2">
<li>pasue connector</li>
</ol>
</li>
<li><ol start="3">
<li>delete history topic</li>
</ol>
<ul>
<li>3.1 å¦‚æœæ­¤æµç¨‹ä¸èµ·ä½œç”¨, å¯ä»¥é‡æ¥ä¸€éï¼Œç„¶ååœ¨æ­¤ä½ç½®ï¼Œæ‰‹åŠ¨åœ¨ topic offsets ä¸‹, æ­¤ connector å¯¹åº”çš„ topic åˆ†åŒºä¸‹ï¼Œæ‰‹åŠ¨æ·»åŠ  offset ä¿¡æ¯, å°† table.whitelist å’Œ table.blacklist è‡ªå®šä¹‰</li>
<li><code>ç¼ºç‚¹</code>:<ul>
<li><ol>
<li>å¯èƒ½ä¼š<code>æ•°æ®é‡å¤</code>ï¼Œ æ–°çš„ offset ä¿¡æ¯ï¼Œ pos æ²¡æœ‰å˜åŒ–ï¼Œé‡å¯åï¼Œå†ä» æ­¤ pos ä½ç½®è¯»å–æ•°æ®ï¼Œæ­¤ä½ç½®åï¼Œå·²ç»å­˜å‚¨çš„æ•°æ®ï¼Œå°±ä¼šå‡ºç°é‡å¤ã€‚</li>
</ol>
</li>
<li><ol start="2">
<li>å¦‚æœæ‰‹åŠ¨æ’å…¥çš„æ­¤æ¡ offset pos/gtid ä¿¡æ¯è¿‡æ—§ï¼Œé‚£ä¹ˆæ–°è¡¨ä¼šæŠŠæ­¤ offset pos/gtid åçš„æ‰€æœ‰ç¬¦åˆè¡¨ç™½åå•çš„æ•°æ®ï¼ŒåŒæ­¥åˆ° kafkaï¼›<code>å¦‚æœæ•°æ®éå¸¸å¤š</code>ï¼Œ<code>æ¯”è¾ƒè€—æ—¶</code>ï¼›æ¯•ç«Ÿå• connector å• task å¤„ç†æ•°æ®ï¼Œæ¯ç§’ 3300 æ¡æ‰€æœ‰</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li><ol start="4">
<li>update config (â€œsnapshot.modeâ€: â€œschema_only_recoveryâ€)</li>
</ol>
</li>
<li><ol start="5">
<li>restart connector\task</li>
</ol>
</li>
<li><ol start="6">
<li>write data to new table</li>
</ol>
</li>
<li><ol start="7">
<li>æ¢å¤ snapshot.mode</li>
</ol>
</li>
</ul>
</li>
<li>æ–°æ–¹æ³•:<ul>
<li>åŠŸèƒ½ä»åœ¨æµ‹è¯•ä¸­ 0.9.0 ç‰ˆæœ¬æ·»åŠ </li>
<li>connector config ä¸­åŠ å…¥ â€œsnapshot.new.tablesâ€: â€œparallelâ€, (off ä¸ºå…³é—­ whitelist å®æ—¶å˜æ›´)</li>
<li>ç„¶åé€šè¿‡ restful api ä¾æ¬¡é‡å¯ connectorã€task</li>
</ul>
</li>
<li>é‡ç‚¹:<ul>
<li>æ–°æ–¹æ³•è²Œä¼¼ä¸å¤ªå¥½ç”¨, ä¸€é¡¿ä¹±ä¸ƒå…«ç³Ÿæ“ä½œåå°±åºŸäº†ã€‚ä½†æ˜¯æŠŠ connect å®¹å™¨å…¨éƒ¨é‡å»ºä¹‹åå¯ç”¨(é‡å¯æ— ç”¨), æ¯”è¾ƒè¯¡å¼‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>æ›´å¤šä¿¡æ¯, æ¯”å¦‚ topic å†…æ•°æ®æ ¼å¼, æ›´å¤šçš„æ•°æ®æ ¼å¼å…¼å®¹é—®é¢˜, è¯·æŸ¥çœ‹å‚è€ƒæ–‡ç« </p>
</blockquote>
<p>å‚è€ƒ: <br></p>
<ul>
<li><a href="https://debezium.io/documentation/reference/1.1/connectors/mysql.html" target="_blank" rel="noopener">debezium mysql</a></li>
</ul>
]]></content>
      <categories>
        <category>Debezium</category>
      </categories>
      <tags>
        <tag>Debezium</tag>
      </tags>
  </entry>
  <entry>
    <title>Mongo Connector</title>
    <url>/2020/05/28/debezium/mongo/</url>
    <content><![CDATA[<p>ä¾èµ–äº mongodb çš„å¤åˆ¶(å‰¯æœ¬é›†), é‡æ”¾ oplog å®ç°æ•°æ®å˜æ›´è¡Œæ•æ‰</p>
<a id="more"></a>
<h2 id="1-connector"><a href="#1-connector" class="headerlink" title="1. connector"></a>1. connector</h2><ul>
<li><ol>
<li>ä¾èµ–äº mongodb çš„å‰¯æœ¬é›†, åˆ©ç”¨ oplog å®Œæˆæ•°æ®åŒæ­¥</li>
</ol>
</li>
<li><ol start="2">
<li>è¯»å–å‰¯æœ¬é›†çš„ primary node, æ ¹æ®å‰¯æœ¬é›†çŠ¶æ€, å§‹ç»ˆä¿æŒè¿æ¥ primary node (æ‰€ä»¥ç¡®ä¿å‰¯æœ¬é›†çš„æ³¨å†Œ host å¯ä»¥è¢«å¤–éƒ¨è®¿é—®)</li>
</ol>
<ul>
<li>å‰¯æœ¬é›†æ¨¡å¼ä¸‹æ‰€æœ‰çš„å‰¯æœ¬åœ°å€(rs.add çš„åœ°å€)å¿…é¡»ä¿è¯ connector å¯ä»¥è®¿é—®</li>
<li>åˆ†ç‰‡æ¨¡å¼:<ul>
<li>è¦ä¿è¯ mongs hostã€mongos â€“configdb é…ç½®çš„ config hostã€mongos æ·»åŠ çš„åˆ†ç‰‡ host (sh.addShard)ã€ config server å‰¯æœ¬é›† (rs.add çš„ host)ã€shard å‰¯æœ¬é›†ï¼ˆrs.add çš„ hostï¼‰å…¨éƒ¨å¯ä»¥è¢« connector è®¿é—®</li>
<li>è¦ä¿è¯ config serverã€åˆ†ç‰‡ä¸‹æ‹¥æœ‰ç‰¹æ®Šæƒé™ç”¨æˆ·<ul>
<li>å¦å¤–, åˆ†ç‰‡ä¸‹ç”¨æˆ·æ— æ³•é€šè¿‡ mongos åˆ›å»º, éœ€è¦åˆ†åˆ«åˆ›å»º</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ol start="3">
<li>ä¸€ä¸ª collection ä¸€ä¸ª topic, å’Œå‰¯æœ¬é›†ã€åˆ†ç‰‡æ•°æ— å…³</li>
</ol>
</li>
<li><ol start="4">
<li>topic åˆ†åŒºæ–¹é¢</li>
</ol>
<ul>
<li>å¯ä»¥ç¡®ä¿åŒä¸€ key è¿›å…¥åŒä¸€ topic, å³å¯ä»¥ç¡®ä¿æ¯ä¸ª document æ“ä½œçš„é¡ºåºæ€§, æ‰€ä»¥åˆ†åŒºæ²¡ä»€ä¹ˆå½±å“</li>
</ul>
</li>
<li><ol start="5">
<li>é…ç½®é¡¹</li>
</ol>
<ul>
<li><ol start="0">
<li>mongodb.hosts (host:port)</li>
</ol>
<ul>
<li>å‰¯æœ¬é›†æ¨¡å¼: ä¸»å‰¯æœ¬ host, å…¶å®æ— æ‰€è°“ (å‰¯æœ¬é›†çš„ä¸»å‰¯å¹¶ä¸å›ºå®š, å†…éƒ¨è‡ªè¡Œé€‰ä¸¾)</li>
<li>åˆ†ç‰‡å‰¯æœ¬é›†: config server host</li>
</ul>
</li>
<li><ol>
<li>æŒ‡æ•°è§„é¿é…ç½® (æš‚æ—¶å¯ä»¥ä¸äºˆå…³æ³¨)</li>
</ol>
<ul>
<li>connect.backoff.initial.delay.ms: 1s</li>
<li>connect.backoff.max.delay.ms: 120s</li>
<li>connect.max.attempts: 16</li>
</ul>
</li>
<li><ol start="2">
<li>snapshot.mode</li>
</ol>
<ul>
<li>connector è¿æ¥æ—¶æ˜¯å¦è¿›è¡Œæ•°æ®å¤‡ä»½</li>
<li>initial: è¿›è¡Œè¿‡å¾€æ•°æ® copy</li>
<li>never: åªè®°å½•æ–°æ•°æ®</li>
</ul>
</li>
<li><ol start="3">
<li>tasks.max</li>
</ol>
<ul>
<li>é»˜è®¤ 1</li>
<li>å¤§äºç­‰äºåˆ†ç‰‡æ•°</li>
</ul>
</li>
<li><ol start="4">
<li>tombstones.on.delete</li>
</ol>
<ul>
<li>å¢“ç¢‘äº‹ä»¶</li>
</ul>
</li>
<li><ol start="5">
<li>mongodb.user</li>
</ol>
</li>
<li><ol start="6">
<li>mongodb.password</li>
</ol>
</li>
<li><ol start="7">
<li>mongodb.name:</li>
</ol>
<ul>
<li>ç±»ä¼¼ mysql/pg connector çš„ database.server.name, å”¯ä¸€ã€kafka topic å‰ç¼€</li>
</ul>
</li>
<li><ol start="8">
<li>database.whitelist</li>
</ol>
</li>
<li><ol start="9">
<li>collection.whitelist</li>
</ol>
</li>
</ul>
</li>
<li>æ³¨æ„äº‹é¡¹:<ul>
<li>å‘½åè§„åˆ™<ul>
<li><ol>
<li>æœåŠ¡å /[a-z,A-Z,_][a-z,a-z,0-9,_]+/<br>-</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>config demo</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"connector.class"</span>: <span class="string">"io.debezium.connector.mongodb.MongoDbConnector"</span>,</span><br><span class="line">	  <span class="attr">"mongodb.hosts"</span>: <span class="string">"192.168.4.23:27017"</span>,</span><br><span class="line">	  <span class="attr">"mongodb.name"</span>: <span class="string">"mongo_01"</span>,</span><br><span class="line">    <span class="attr">"mongodb.user"</span>: <span class="string">"debezium"</span>,</span><br><span class="line">    <span class="attr">"mongodb.password"</span>: <span class="string">"dbz"</span>,</span><br><span class="line">    <span class="attr">"database.whitelist"</span>: <span class="string">"inventory"</span>,</span><br><span class="line">    <span class="attr">"collection.whitelist"</span>: <span class="string">"inventory.customers,inventory.orders"</span>,</span><br><span class="line">    <span class="attr">"snapshot.mode"</span>: <span class="string">"never"</span>,</span><br><span class="line">    <span class="attr">"tasks.max"</span>: <span class="string">"1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-database"><a href="#2-database" class="headerlink" title="2. database"></a>2. database</h2><ul>
<li>é›†ç¾¤æ¨¡å¼<ul>
<li>åˆ†ç‰‡æ¨¡å¼å’Œå‰¯æœ¬é›†æ¨¡å¼(éœ€è¦ oplog)</li>
<li>éœ€è¦æœ‰æƒé™è¯»å– oplog é›†åˆçš„è´¦æˆ·</li>
</ul>
</li>
<li>æ³¨æ„äº‹é¡¹:<ul>
<li>å‘½åè§„åˆ™</li>
<li>å‰¯æœ¬é›†æ¨¡å¼<ul>
<li>å†…éƒ¨æƒé™ (keyfile)</li>
<li>ä¿è¯ rs.add çš„æ¯ä¸ªèŠ‚ç‚¹åœ°å€, connector éƒ½å¯ä»¥è®¿é—®</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>ç‰¹æ®Šæƒé™ç”¨æˆ·, æ¯ä¸ªåˆ†ç‰‡éƒ½éœ€è¦(æ„Ÿè§‰è¿™ä¸€ç‚¹æœ‰ç‚¹é—®é¢˜ï¼Œå¤ªç¹çäº†ï¼Œæ˜¯ç”¨é”™äº†ï¼Œè¿˜æ˜¯æ€ä¹ˆå›äº‹)</p>
</blockquote>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">use</span> <span class="selector-tag">admin</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.runCommand</span>(&#123;</span><br><span class="line">    <span class="attribute">createRole</span>: <span class="string">"listDatabases"</span>,</span><br><span class="line">    <span class="attribute">privileges</span>: [</span><br><span class="line">        &#123; <span class="attribute">resource</span>: &#123; <span class="attribute">cluster </span>: true &#125;, <span class="attribute">actions</span>: [<span class="string">"listDatabases"</span>]&#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attribute">roles</span>: []</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.createUser</span>(&#123;</span><br><span class="line">    <span class="attribute">user</span>: <span class="string">'debezium'</span>,</span><br><span class="line">    <span class="attribute">pwd</span>: <span class="string">'dbz'</span>,</span><br><span class="line">    <span class="attribute">roles</span>: [</span><br><span class="line">        &#123; <span class="attribute">role</span>: <span class="string">"readWrite"</span>, <span class="attribute">db</span>: <span class="string">"inventory"</span> &#125;, <span class="comment">// inventory ä¸ºç›‘æ§åº“</span></span><br><span class="line">        &#123; <span class="attribute">role</span>: <span class="string">"read"</span>, <span class="attribute">db</span>: <span class="string">"local"</span> &#125;,</span><br><span class="line">        &#123; <span class="attribute">role</span>: <span class="string">"listDatabases"</span>, <span class="attribute">db</span>: <span class="string">"admin"</span> &#125;,</span><br><span class="line">        &#123; <span class="attribute">role</span>: <span class="string">"read"</span>, <span class="attribute">db</span>: <span class="string">"config"</span> &#125;,</span><br><span class="line">        &#123; <span class="attribute">role</span>: <span class="string">"read"</span>, <span class="attribute">db</span>: <span class="string">"admin"</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="3-æµç¨‹"><a href="#3-æµç¨‹" class="headerlink" title="3. æµç¨‹"></a>3. æµç¨‹</h2><ul>
<li>Initial sync<ul>
<li>åˆå§‹åŒ–åŒæ­¥ oplog</li>
</ul>
</li>
<li>Tailing the oplog<ul>
<li>æ‹¥æœ‰ offset å, è¯»å– oplog</li>
</ul>
</li>
</ul>
<h2 id="4-topic-payload-æ„æˆ"><a href="#4-topic-payload-æ„æˆ" class="headerlink" title="4. topic payload æ„æˆ"></a>4. topic payload æ„æˆ</h2><ul>
<li>after: init å’Œ create æ—¶çš„å®Œæ•´æ•°æ®</li>
<li>patch: update æ—¶çš„ sql</li>
<li>op:<ul>
<li>r: snaphsot init</li>
<li>u: update</li>
<li>d: delete</li>
<li>c: create</li>
</ul>
</li>
</ul>
<h3 id="1-init-snapshot"><a href="#1-init-snapshot" class="headerlink" title="1. init snapshot"></a>1. init snapshot</h3><blockquote>
<p>operation: r</p>
</blockquote>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line"><span class="string">"payload"</span>: &#123;</span><br><span class="line">    <span class="string">"after"</span>: <span class="string">"&#123;\"</span>_id\<span class="string">": &#123;\"</span>$numberLong\<span class="string">": \"</span><span class="number">1001</span>\<span class="string">"&#125;,\"</span>first_name\<span class="string">": \"</span>Sally12\<span class="string">",\"</span>last_name\<span class="string">": \"</span>Thomas\<span class="string">",\"</span>email\<span class="string">": \"</span>sally.thomas<span class="symbol">@acme</span>.com\<span class="string">"&#125;"</span>,</span><br><span class="line">    <span class="string">"patch"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">      <span class="string">"version"</span>: <span class="string">"0.10.0.Final"</span>,</span><br><span class="line">      <span class="string">"connector"</span>: <span class="string">"mongodb"</span>,</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"mongo_02"</span>,</span><br><span class="line">      <span class="string">"ts_ms"</span>: <span class="number">1574235688000</span>,</span><br><span class="line">      <span class="string">"snapshot"</span>: <span class="string">"true"</span>,</span><br><span class="line">      <span class="string">"db"</span>: <span class="string">"inventory"</span>,</span><br><span class="line">      <span class="string">"rs"</span>: <span class="string">"rs0"</span>,</span><br><span class="line">      <span class="string">"collection"</span>: <span class="string">"customers"</span>,</span><br><span class="line">      <span class="string">"ord"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="string">"h"</span>: <span class="number">5175105543699020230</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"op"</span>: <span class="string">"r"</span>,</span><br><span class="line">    <span class="string">"ts_ms"</span>: <span class="number">1574235691071</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-create"><a href="#2-create" class="headerlink" title="2. create"></a>2. create</h3><blockquote>
<p>operation: c</p>
</blockquote>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line"><span class="string">"payload"</span>: &#123;</span><br><span class="line">    <span class="string">"after"</span>: <span class="string">"&#123;\"</span>_id\<span class="string">": &#123;\"</span>$oid\<span class="string">": \"</span><span class="number">5</span>dd4ef7e9e9939487b6c0239\<span class="string">"&#125;,\"</span>first_name\<span class="string">": 3.0,\"</span>last_name\<span class="string">": 4.0,\"</span>email\<span class="string">": 5.0&#125;"</span>,</span><br><span class="line">    <span class="string">"patch"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">      <span class="string">"version"</span>: <span class="string">"0.10.0.Final"</span>,</span><br><span class="line">      <span class="string">"connector"</span>: <span class="string">"mongodb"</span>,</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"mongo_02"</span>,</span><br><span class="line">      <span class="string">"ts_ms"</span>: <span class="number">1574236030000</span>,</span><br><span class="line">      <span class="string">"snapshot"</span>: <span class="string">"false"</span>,</span><br><span class="line">      <span class="string">"db"</span>: <span class="string">"inventory"</span>,</span><br><span class="line">      <span class="string">"rs"</span>: <span class="string">"rs0"</span>,</span><br><span class="line">      <span class="string">"collection"</span>: <span class="string">"customers"</span>,</span><br><span class="line">      <span class="string">"ord"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="string">"h"</span>: <span class="number">131523180395089317</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"op"</span>: <span class="string">"c"</span>,</span><br><span class="line">    <span class="string">"ts_ms"</span>: <span class="number">1574236030371</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-update"><a href="#3-update" class="headerlink" title="3. update"></a>3. update</h3><blockquote>
<p>operation: u</p>
</blockquote>
<blockquote>
<p>patch: æ˜¾ç¤º set æ“ä½œ, ä¸ºäº†ä¿è¯ oplog æ“ä½œçš„å¹‚ç­‰æ€§, ä¿è¯é‡å¤æ‰§è¡Œåçš„æ­£ç¡®æ€§</p>
</blockquote>
<blockquote>
<p>æ³¨æ„: patch å†…å®¹ç”± mongodb æä¾›, ä¸” mongodb å„ä¸ªç‰ˆæœ¬ä¹‹é—´çš„ patch å¯èƒ½å­˜åœ¨ä¸åŒ</p>
</blockquote>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line"><span class="string">"payload"</span>: &#123;</span><br><span class="line">  <span class="string">"after"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">"patch"</span>: <span class="string">"&#123;\"</span>$v\<span class="string">": 1,\"</span>$set\<span class="string">": &#123;\"</span>last_name\<span class="string">": 5.0&#125;&#125;"</span>,</span><br><span class="line">  <span class="string">"source"</span>: &#123;</span><br><span class="line">    <span class="string">"version"</span>: <span class="string">"0.10.0.Final"</span>,</span><br><span class="line">    <span class="string">"connector"</span>: <span class="string">"mongodb"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"mongo_02"</span>,</span><br><span class="line">    <span class="string">"ts_ms"</span>: <span class="number">1574236075000</span>,</span><br><span class="line">    <span class="string">"snapshot"</span>: <span class="string">"false"</span>,</span><br><span class="line">    <span class="string">"db"</span>: <span class="string">"inventory"</span>,</span><br><span class="line">    <span class="string">"rs"</span>: <span class="string">"rs0"</span>,</span><br><span class="line">    <span class="string">"collection"</span>: <span class="string">"customers"</span>,</span><br><span class="line">    <span class="string">"ord"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"h"</span>: <span class="number">5737963839219456046</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"op"</span>: <span class="string">"u"</span>,</span><br><span class="line">  <span class="string">"ts_ms"</span>: <span class="number">1574236075380</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-delete"><a href="#4-delete" class="headerlink" title="4. delete"></a>4. delete</h3><blockquote>
<p>operation: d</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"payload"</span>: &#123;</span><br><span class="line">  <span class="string">"after"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">"patch"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">"source"</span>: &#123;</span><br><span class="line">    <span class="string">"version"</span>: <span class="string">"0.10.0.Final"</span>,</span><br><span class="line">    <span class="string">"connector"</span>: <span class="string">"mongodb"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"mongo_02"</span>,</span><br><span class="line">    <span class="string">"ts_ms"</span>: <span class="number">1574237481000</span>,</span><br><span class="line">    <span class="string">"snapshot"</span>: <span class="string">"false"</span>,</span><br><span class="line">    <span class="string">"db"</span>: <span class="string">"inventory"</span>,</span><br><span class="line">    <span class="string">"rs"</span>: <span class="string">"rs0"</span>,</span><br><span class="line">    <span class="string">"collection"</span>: <span class="string">"customers"</span>,</span><br><span class="line">    <span class="string">"ord"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"h"</span>: <span class="number">-3225175849180220485</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"op"</span>: <span class="string">"d"</span>,</span><br><span class="line">  <span class="string">"ts_ms"</span>: <span class="number">1574237481422</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Debezium</category>
      </categories>
      <tags>
        <tag>Debezium</tag>
      </tags>
  </entry>
  <entry>
    <title>Debezium docker å½¢å¼éƒ¨ç½²</title>
    <url>/2020/05/28/debezium/debezium_docker/</url>
    <content><![CDATA[<p>ä»‹ç»é‡‡ç”¨ docker å½¢å¼çš„éƒ¨ç½²å‚æ•°é…ç½®ã€æ³¨æ„äº‹é¡¹</p>
<a id="more"></a>
<h2 id="1-docker-å‚æ•°ä»‹ç»"><a href="#1-docker-å‚æ•°ä»‹ç»" class="headerlink" title="1. docker å‚æ•°ä»‹ç»"></a>1. docker å‚æ•°ä»‹ç»</h2><ul>
<li><code>BOOTSTRAP_SERVERS</code>: kafka:port,kafka2:port<ul>
<li>kafka broker åœ°å€åˆ—è¡¨</li>
</ul>
</li>
<li><code>GROUP_ID</code>:<ul>
<li>åˆ†å¸ƒè¿è¡Œæ¨¡å¼ä¸‹, ä¾›æœåŠ¡é—´äº’ç›¸å‘ç°</li>
</ul>
</li>
<li><code>CONFIG_STORAGE_TOPIC</code>: string<ul>
<li>topic ç‰¹ç‚¹<ul>
<li>å•åˆ†åŒºå¤šå‰¯æœ¬</li>
<li>clean policy: compact (default)</li>
</ul>
</li>
<li>æè¿°: connectorã€task é…ç½®å­˜å‚¨<ul>
<li>å½“é…ç½®å˜æ›´æ—¶æ–°å¢æ•°æ®</li>
</ul>
</li>
<li>è¾…åŠ©å‚æ•°:<ul>
<li>CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: å‰¯æœ¬å› å­ (config.storage.replication.factor)</li>
</ul>
</li>
</ul>
</li>
<li><p><code>OFFSET_STORAGE_TOPIC</code>: string</p>
<ul>
<li>topic ç‰¹ç‚¹<ul>
<li>å¤šåˆ†åŒºå¤šå‰¯æœ¬ (é»˜è®¤ 25 partition, æœ€å° 3 å‰¯æœ¬)</li>
<li>ä½†æ˜¯<code>å½“åˆ†åŒºæ•°å‘ç”Ÿå˜åŒ–æ—¶, ä¼šå‡ºç° bug</code>, connetor é…ç½®ä¹‹å‰å®Œæˆåˆ†åŒºé…ç½® (bug ä¿®å¤å‰ä¸å†æ›´æ”¹åˆ†åŒºæ•°)</li>
<li>clean policy: compact</li>
</ul>
</li>
<li>æè¿°: æ¯ä¸ª connector çš„åç§»é‡å­˜å‚¨</li>
<li>è¾…åŠ©å‚æ•°:<ul>
<li>CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: å‰¯æœ¬å› å­ (offset.storage.replication.factor)</li>
<li>OFFSET_FLUSH_INTERVAL_MS: Int (offset åˆ·æ–°é—´éš”)</li>
</ul>
</li>
</ul>
</li>
<li><p><code>STATUS_STORAGE_TOPIC</code>: string</p>
<ul>
<li>topic ç‰¹ç‚¹<ul>
<li>å¤šåˆ†åŒºå¤šå‰¯æœ¬ (æœªæµ‹è¯•åˆ†åŒºå¢åŠ åçš„æƒ…å†µ, æ˜¯ä¸æ˜¯å’Œä¸Šé¢ offset æœ‰åŒæ ·é—®é¢˜)</li>
<li>clean policy: compact</li>
</ul>
</li>
<li>æè¿°: connectorã€task çŠ¶æ€å­˜å‚¨</li>
<li>è¾…åŠ©å‚æ•°:<ul>
<li>CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: å‰¯æœ¬å› å­ (status.storage.replication.factor)</li>
</ul>
</li>
</ul>
</li>
<li>CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE=false<ul>
<li>converter ä¸º json æ—¶å…³é—­ schema</li>
<li>å†³å®šè¡¨çš„ topic æ•°æ®, key æ˜¯å¦åŒ…å«è¡¨ç»“æ„ä¿¡æ¯</li>
</ul>
</li>
<li>CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE=false<ul>
<li>converter ä¸º json æ—¶å…³é—­ schema</li>
<li>å†³å®šè¡¨çš„ topic æ•°æ®, value æ˜¯å¦åŒ…å«è¡¨ç»“æ„ä¿¡æ¯</li>
</ul>
</li>
<li>CONNECT_PRODUCER_MAX_REQUEST_SIZE=20971520 (å­—èŠ‚)<ul>
<li>ä½œä¸º producer æ—¶, å‘é€æ•°æ®å¤§å°é™åˆ¶. default: 1M</li>
<li>éœ€è¦é…åˆ kafka MESSAGE_MAX_BYTES å­—æ®µ, kafka æ¥æ”¶æ•°æ®å¤§å°é™åˆ¶</li>
</ul>
</li>
<li>CONNECT_DATABASE_HISTORY_KAFKA_RECOVERY_POLL_INTERVAL_MS=1000 ï¼ˆmsï¼‰<ul>
<li>æ¢å¤è¶…æ—¶é…ç½®</li>
<li>history topic ä¿å­˜ schema, connector é‡å¯æ—¶, éœ€è¦æ‹‰å– schema ä¿¡æ¯, ä»¥ä¾¿å¯¹æ•°æ®è¿›è¡Œç‰¹æ®Šæ•°æ®ç±»å‹å¤„ç†.</li>
<li>default: 100ms å¿˜äº†</li>
</ul>
</li>
<li>HEAP_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 # éœ€è¦é…åˆ docker å†…å­˜é™åˆ¶ä½¿ç”¨<ul>
<li>HEAP_OPTS=-Xmx512M -Xms256M</li>
<li>java å†…å­˜é™åˆ¶</li>
</ul>
</li>
</ul>
<h2 id="3-è¿è¡Œæ¨¡å¼"><a href="#3-è¿è¡Œæ¨¡å¼" class="headerlink" title="3. è¿è¡Œæ¨¡å¼"></a>3. è¿è¡Œæ¨¡å¼</h2><ul>
<li>å•æœºæ¨¡å¼<ul>
<li>å­—é¢æ„æ€</li>
</ul>
</li>
<li>é›†ç¾¤æ¨¡å¼<ul>
<li>å‚æ•°é…ç½®: GROUP_ID (å”¯ä¸€å­—ç¬¦ä¸², ç”¨æ¥ connect æœåŠ¡ä¹‹é—´äº’ç›¸å‘ç°)</li>
<li>ç®€å•ä»‹ç»: å½“ connect æœåŠ¡å®•æœºå, å¯ä»¥ä¿è¯ connector ä»»åŠ¡åœ¨å…¶ä»–åŒé›†ç¾¤ä¸‹ connect æœåŠ¡ä¸­åˆ›å»ºå¹¶è¿è¡Œ<ul>
<li>é›†ç¾¤å¤š debezium è‡ªå·±å®Œæˆ leader é€‰ä¸¾</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="4-Rest-api"><a href="#4-Rest-api" class="headerlink" title="4. Rest api"></a>4. Rest api</h2><blockquote>
<p><a href="http://kafka.apache.org/documentation.html#connect" target="_blank" rel="noopener">http://kafka.apache.org/documentation.html#connect</a></p>
</blockquote>
<ul>
<li>GET /connectors â€“ è¿”å›æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ connector å</li>
<li>POST /connectors â€“ æ–°å»ºä¸€ä¸ª connector;è¯·æ±‚ä½“å¿…é¡»æ˜¯ json æ ¼å¼å¹¶ä¸”éœ€è¦åŒ…å« name å­—æ®µå’Œ config å­—æ®µï¼Œname æ˜¯ connector çš„åå­—ï¼Œconfig æ˜¯ json æ ¼å¼ï¼Œå¿…é¡»åŒ…å«ä½ çš„ connector çš„é…ç½®ä¿¡æ¯ã€‚</li>
<li>GET /connectors/{name} â€“ è·å–æŒ‡å®š connetor çš„ä¿¡æ¯</li>
<li>GET /connectors/{name}/config â€“ è·å–æŒ‡å®š connector çš„é…ç½®ä¿¡æ¯</li>
<li>PUT /connectors/{name}/config â€“ æ›´æ–°æŒ‡å®š connector çš„é…ç½®ä¿¡æ¯ (å®Œæ•´çš„ config json)</li>
<li>GET /connectors/{name}/status â€“ è·å–æŒ‡å®š connector çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å®ƒæ˜¯å¦åœ¨è¿è¡Œã€åœæ­¢ã€æˆ–è€…å¤±è´¥ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè¿˜ä¼šåˆ—å‡ºé”™è¯¯çš„å…·ä½“ä¿¡æ¯ã€‚</li>
<li>GET /connectors/{name}/tasks â€“ è·å–æŒ‡å®š connector æ­£åœ¨è¿è¡Œçš„ taskã€‚</li>
<li>GET /connectors/{name}/tasks/{taskid}/status â€“ è·å–æŒ‡å®š connector çš„ task çš„çŠ¶æ€ä¿¡æ¯</li>
<li>PUT /connectors/{name}/pause â€“ æš‚åœ connector å’Œå®ƒçš„ taskï¼Œåœæ­¢æ•°æ®å¤„ç†çŸ¥é“å®ƒè¢«æ¢å¤ã€‚</li>
<li>PUT /connectors/{name}/resume â€“ æ¢å¤ä¸€ä¸ªè¢«æš‚åœçš„ connector</li>
<li>POST /connectors/{name}/restart â€“ é‡å¯ä¸€ä¸ª connectorï¼Œå°¤å…¶æ˜¯åœ¨ä¸€ä¸ª connector è¿è¡Œå¤±è´¥çš„æƒ…å†µä¸‹æ¯”è¾ƒå¸¸ç”¨</li>
<li>POST /connectors/{name}/tasks/{taskId}/restart â€“ é‡å¯ä¸€ä¸ª taskï¼Œä¸€èˆ¬æ˜¯å› ä¸ºå®ƒè¿è¡Œå¤±è´¥æ‰è¿™æ ·åšã€‚</li>
<li>DELETE /connectors/{name} â€“ åˆ é™¤ä¸€ä¸ª connectorï¼Œåœæ­¢å®ƒçš„æ‰€æœ‰ task å¹¶åˆ é™¤é…ç½®</li>
<li>PUT /connector-plugins/{connector name: string}/config/validate<ul>
<li>req: config å†…å®¹</li>
</ul>
</li>
</ul>
<h2 id="5-å®¹å™¨å†…é…ç½®æ–‡ä»¶ä»¥åŠ-debezium-é•œåƒå®šåˆ¶"><a href="#5-å®¹å™¨å†…é…ç½®æ–‡ä»¶ä»¥åŠ-debezium-é•œåƒå®šåˆ¶" class="headerlink" title="5. å®¹å™¨å†…é…ç½®æ–‡ä»¶ä»¥åŠ debezium é•œåƒå®šåˆ¶"></a>5. å®¹å™¨å†…é…ç½®æ–‡ä»¶ä»¥åŠ debezium é•œåƒå®šåˆ¶</h2><h3 id="5-1-èƒŒæ™¯"><a href="#5-1-èƒŒæ™¯" class="headerlink" title="5.1 èƒŒæ™¯"></a>5.1 èƒŒæ™¯</h3><p>é€šè¿‡æ­¥éª¤å›› debezium æä¾›çš„ restful api åœ¨åˆ›å»º CDC ç›‘æ§ä»»åŠ¡æ—¶ï¼Œæ•°æ®åº“ä¿¡æ¯è¢«æ˜¾ç¤ºçš„ä¹¦å†™ï¼Œå®¹æ˜“é€ æˆæ•°æ®åº“ä¿¡æ¯æ³„éœ²ï¼Œéå¸¸å±é™©</p>
<p>æš´éœ²åœºæ™¯å¦‚ä¸‹<br>å…·ä½“åœºæ™¯å¦‚ä¸‹: <br></p>
<ol>
<li>åˆ›å»ºç›‘æ§ connector (connector æ˜¯ç›‘æ§ä»»åŠ¡çš„æœ€å¤§å•å…ƒ)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Post /connectors</span><br><span class="line">&#123;</span><br><span class="line">    name: '',</span><br><span class="line">    config: &#123;</span><br><span class="line">        database.hostname: '',</span><br><span class="line">        database.user: '',</span><br><span class="line">        database.password: '',</span><br><span class="line">        database.whitelist: 'dbname',</span><br><span class="line">        talbe.whitelist: 'dbname.tableA,dbname.tabelB'</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>æŸ¥çœ‹ connector é…ç½®ä¿¡æ¯</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET /connectors/name/config</span><br><span class="line">&#123;</span><br><span class="line">    database.hostname: '',</span><br><span class="line">    database.user: '',</span><br><span class="line">    database.password: '',</span><br><span class="line">    database.whitelist: 'dbname',</span><br><span class="line">    talbe.whitelist: 'dbname.tableA,dbname.tabelB'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>æ›´æ–° connector é…ç½®ä¿¡æ¯ï¼ˆéœ€è¦å…¨é‡ä¿¡æ¯ï¼Œå³ä¹Ÿéœ€è¦æ•°æ®åº“ä¿¡æ¯ï¼‰</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Put /connectors/name/config</span><br><span class="line">&#123;</span><br><span class="line">    database.hostname: '',</span><br><span class="line">    database.user: '',</span><br><span class="line">    database.password: '',</span><br><span class="line">    database.whitelist: 'dbname',</span><br><span class="line">    talbe.whitelist: 'dbname.tableA,dbname.tabelB'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç®€è€Œè¨€ä¹‹, rest api èƒ½å¤Ÿç›´æ¥æ‹¿åˆ°çº¿ä¸Šçš„æ•°æ®åº“é…ç½®ä¿¡æ¯</p>
</blockquote>
<h3 id="5-2-å…‰æ”¾è§£å†³æ–¹æ¡ˆ"><a href="#5-2-å…‰æ”¾è§£å†³æ–¹æ¡ˆ" class="headerlink" title="5.2 å…‰æ”¾è§£å†³æ–¹æ¡ˆ"></a>5.2 å…‰æ”¾è§£å†³æ–¹æ¡ˆ</h3><p>debezium æä¾›äº†<a href="https://debezium.io/blog/2019/12/13/externalized-secrets/" target="_blank" rel="noopener">æ•°æ®åº“è¿æ¥ä¿¡æ¯ç§å¯†åŒ–</a>çš„åŠŸèƒ½</p>
<h4 id="5-2-1-docker-å®¹å™¨é…ç½®"><a href="#5-2-1-docker-å®¹å™¨é…ç½®" class="headerlink" title="5.2.1 docker å®¹å™¨é…ç½®"></a>5.2.1 docker å®¹å™¨é…ç½®</h4><blockquote>
<p>å¢åŠ ç¯å¢ƒå˜é‡</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">CONNECT_CONFIG_PROVIDERS = file</span><br><span class="line">CONNECT_CONFIG_PROVIDERS_FILE_CLASS =</span><br><span class="line">  org.apache.kafka.common.config.provider.FileConfigProvider</span><br></pre></td></tr></table></figure>
<h4 id="5-2-2-Api-å˜æ›´"><a href="#5-2-2-Api-å˜æ›´" class="headerlink" title="5.2.2 Api å˜æ›´"></a>5.2.2 Api å˜æ›´</h4><p>ä½¿ç”¨ <code>${file:/kafka/dbconfig/config_name:config_key}</code> å½¢å¼, æ¥ä»£æ›¿æ•°æ®åº“ä¿¡æ¯, å¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Post /connectors</span><br><span class="line">&#123;</span><br><span class="line">    name: <span class="string">''</span>,</span><br><span class="line">    config: &#123;</span><br><span class="line">        <span class="string">"database.hostname"</span>: <span class="string">"$&#123;file:/kafka/dbconfig/mysql_server_01.conf:MYSQL_SERVER_ADDRESS&#125;"</span>,</span><br><span class="line">        <span class="string">"database.user"</span>: <span class="string">"$&#123;file:/kafka/dbconfig/mysql_server_01.conf:MYSQL_SERVER_USERNAME&#125;"</span>,</span><br><span class="line">        <span class="string">"database.password"</span>: <span class="string">"$&#123;file:/kafka/dbconfig/mysql_server_01.conf:MYSQL_SERVER_PASSWORD&#125;"</span>,</span><br><span class="line">        <span class="string">"database.whitelist"</span>: <span class="string">"$&#123;file:/kafka/dbconfig/mysql_server_01.conf:MATERIAL_DATABASE_NAME&#125;"</span>,</span><br><span class="line">        <span class="string">"table.whitelist"</span>: <span class="string">"$&#123;file:/kafka/dbconfig/mysql_server_01.conf:MATERIAL_DATABASE_NAME&#125;.shop"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>file:/kafka/dbconfig/mysql_server_01.conf</code> å³ä¸ºé…ç½®æ–‡ä»¶åœ¨ docker å®¹å™¨ä¸­çš„ç»å¯¹è·¯å¾„<br>mysql_server_01.conf<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">MYSQL_SERVER_ADDRESS=aaa</span></span><br><span class="line"><span class="string">MYSQL_SERVER_USERNAME=bbb</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>æ³¨æ„: ä¸è¦æœ‰ä»»ä½•å…¶ä»–ç¬¦å·, æ¯”å¦‚å¼•å·</p>
</blockquote>
<p>è¿™æ ·æ— è®ºåœ¨ get è¯·æ±‚ è¿˜æ˜¯ kafka ä¿¡æ¯ä¸­, hostname\user\password, éƒ½æ˜¯å¦‚ä¸Šå½¢å¼è¿›è¡Œå±•ç¤º <br><br>dbname ä¼šåœ¨ kafka topic çš„ offset topic ä¸­æš´éœ²ï¼Œä¸è¿‡æ²¡ä»€ä¹ˆå•¥å½±å“</p>
<h3 id="5-3-è§£å†³æ–¹æ¡ˆå®æ–½"><a href="#5-3-è§£å†³æ–¹æ¡ˆå®æ–½" class="headerlink" title="5.3 è§£å†³æ–¹æ¡ˆå®æ–½"></a>5.3 è§£å†³æ–¹æ¡ˆå®æ–½</h3><p>ç”±äºè¯¥æ–¹æ¡ˆï¼Œåªæ”¯æŒè¯»å–å®¹å™¨å†…é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥è·å–ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ä¸»è¦å·¥ä½œå°±æ˜¯æŠŠæ•°æ®åº“é…ç½®æ–‡ä»¶ï¼Œæ”¾å…¥å®¹å™¨ä¸­ï¼Œé‡æ–°åˆ¶ä½œé•œåƒã€‚<br></p>
<ul>
<li>æ–¹æ¡ˆä¸€: åˆ¶ä½œé•œåƒæ—¶, æŠŠæ–‡ä»¶æ”¾åˆ°æŒ‡å®šä½ç½®å³å¯</li>
<li>æ–¹æ¡ˆäºŒ: æ›´ç¨³çµæ´», åœ¨åŸæœ‰åŸºç¡€ä¸Š, æ·»åŠ æ–°çš„ debezium å¯åŠ¨è„šæœ¬ï¼Œ<ul>
<li>å¯åŠ¨ä¹‹å‰ï¼Œå»æ‹‰å–é…ç½®æ–‡ä»¶æœåŠ¡å™¨ä¸‹è½½å¯¹åº”é…ç½®æ–‡ä»¶åˆ°ç½®é¡¶ä½ç½®</li>
<li>æ­£å¸¸å¯åŠ¨æœåŠ¡</li>
<li><a href="https://github.com/houkk/debezium_docker" target="_blank" rel="noopener">ç¤ºä¾‹</a></li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>Debezium</category>
      </categories>
      <tags>
        <tag>Debezium</tag>
      </tags>
  </entry>
  <entry>
    <title>helm -- kubernets çš„åŒ…ç®¡ç†å·¥å…·</title>
    <url>/2018/01/16/k8s/helm-md/</url>
    <content><![CDATA[<p>Helm æ˜¯ Kubernetes çš„ä¸€ä¸ªåŒ…ç®¡ç†å·¥å…·ï¼Œç”¨æ¥ç®€åŒ– Kubernetes åº”ç”¨çš„éƒ¨ç½²å’Œç®¡ç†ã€‚å¯ä»¥æŠŠ Helm æ¯”ä½œ CentOS çš„ yum å·¥å…·ï¼Œ è€Œæˆ‘ä»¬çš„æœåŠ¡å¯ä»¥çœ‹ä½œæ˜¯ rpm åŒ…ã€‚</p>
<a id="more"></a>
<h3 id="1-åŸºæœ¬æ¦‚å¿µ"><a href="#1-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="1. åŸºæœ¬æ¦‚å¿µ"></a>1. åŸºæœ¬æ¦‚å¿µ</h3><p>1ï¼‰Chart: æ˜¯ Helm ç®¡ç†çš„å®‰è£…åŒ…ï¼Œé‡Œé¢åŒ…å«éœ€è¦éƒ¨ç½²çš„å®‰è£…åŒ…èµ„æº<br><br>2ï¼‰Releaseï¼šæ˜¯ chart çš„éƒ¨ç½²å®ä¾‹ï¼Œä¸€ä¸ª chart åœ¨ä¸€ä¸ª Kubernetes é›†ç¾¤ä¸Šå¯ä»¥æœ‰å¤šä¸ª releaseï¼Œå³è¿™ä¸ª chart å¯ä»¥è¢«å®‰è£…å¤šæ¬¡<br><br>3ï¼‰Repositoryï¼šchart çš„ä»“åº“ï¼Œç”¨äºå‘å¸ƒå’Œå­˜å‚¨ chart<br></p>
<h3 id="2-ç»„æˆ"><a href="#2-ç»„æˆ" class="headerlink" title="2. ç»„æˆ"></a>2. ç»„æˆ</h3><p>Helm æ˜¯ C/S æ¶æ„ï¼Œ æœ‰ client å’Œ server æ„æˆã€‚<br><br><code>tiller</code>(server): è¿è¡Œåœ¨ Kubernetes é›†ç¾¤ä¸Š;<br><br><code>helm</code>(client,å‘½ä»¤è¡Œå·¥å…·)ï¼šå¯åœ¨æœ¬åœ°è¿è¡Œï¼Œä¸€èˆ¬è¿è¡Œåœ¨CI/CD Serverä¸Š</p>
<h3 id="3-å®‰è£…-å’Œ-åˆå§‹åŒ–"><a href="#3-å®‰è£…-å’Œ-åˆå§‹åŒ–" class="headerlink" title="3. å®‰è£… å’Œ åˆå§‹åŒ–"></a>3. å®‰è£… å’Œ åˆå§‹åŒ–</h3><p>å®‰è£…æ•™ç¨‹ï¼Œ ä»¥åŠåˆå§‹åŒ–æ•™ç¨‹ï¼Œ å¯ä»¥å‚è€ƒ <a href="https://github.com/kubernetes/helm/blob/master/docs/install.md" target="_blank" rel="noopener">helm github install.md</a></p>
<h3 id="4-role-based-access-control-åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶"><a href="#4-role-based-access-control-åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶" class="headerlink" title="4. role-based access control(åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶)"></a>4. role-based access control(åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶)</h3><p>åœ¨ Kubernetes 1.8ï¼ŒKubernetes APIServer æ­£å¼å¼€å¯äº†RBACè®¿é—®æ§åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ›å»º tiller ä½¿ç”¨çš„service account: tiller å¹¶åˆ†é…åˆé€‚çš„è§’è‰²ç»™å®ƒã€‚æœ¬æ–‡ä¸å¤šåšè¯´æ˜ï¼Œ å…³äºå¦‚ä½•é…ç½®è¯·å‚è€ƒ<a href="https://docs.helm.sh/using_helm/#role-based-access-control" target="_blank" rel="noopener">tiller and RBAC</a>ã€‚è‡³äº RBACï¼Œ å¯ä»¥å‚è€ƒ <a href="https://coreos.com/blog/hands-on-with-rbac-in-kubernetes-1.8" target="_blank" rel="noopener">Hands on with RBAC in Kubernetes 1.8</a></p>
<h3 id="5-åŸºæœ¬ä½¿ç”¨"><a href="#5-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="5. åŸºæœ¬ä½¿ç”¨"></a>5. åŸºæœ¬ä½¿ç”¨</h3><h4 id="5-1-åˆ›å»º-chart"><a href="#5-1-åˆ›å»º-chart" class="headerlink" title="5.1 åˆ›å»º chart"></a>5.1 åˆ›å»º chart</h4><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">$ helm tree hello-world </span><br><span class="line">hello-world</span><br><span class="line">â”œâ”€â”€ charts</span><br><span class="line">â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”œâ”€â”€ templates</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ deployment.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ _helpers.tpl</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ingress.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ NOTES.txt</span><br><span class="line">â”‚Â Â  â””â”€â”€ service.yaml</span><br><span class="line">â””â”€â”€ values.yaml</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> directories, <span class="number">7</span> files</span><br></pre></td></tr></table></figure>
<ol><br><li>charts: æœ¬chartä¾èµ–çš„chartï¼Œå½“å‰æ˜¯ç©ºçš„;</li><br><li>Chart.yaml: åŸºæœ¬ä¿¡æ¯<br><br><br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">Helm</span> <span class="string">chart</span> <span class="string">for</span> <span class="string">Kubernetes</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">microservice</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><br><br></li><br><li>templates: èµ„æºå®šä¹‰æ–‡ä»¶ï¼ˆserverceï¼Œ deployment ..etcï¼‰</li><br><li>values.yaml: chart é…ç½®é»˜è®¤å€¼ï¼Œ åœ¨ templates æ–‡ä»¶ä¸­è°ƒç”¨</li><br></ol>

<h4 id="5-2-å®‰è£…"><a href="#5-2-å®‰è£…" class="headerlink" title="5.2 å®‰è£…"></a>5.2 å®‰è£…</h4><p>ç›´æ¥åœ¨ä¸Šæ–‡åˆ›å»ºå‡ºæ¥çš„ <code>hello-world</code> chat ç›®å½•ä¸‹ï¼Œ æ‰§è¡Œ<br><br><code>helm install ./</code><br>æŸ¥çœ‹ releaseï¼š<br><br><code>helm list</code><br>åˆ é™¤ releaseï¼š <br><br><code>helm delete release-name</code></p>
<h4 id="5-3-æ‰“åŒ…åˆ†å‘"><a href="#5-3-æ‰“åŒ…åˆ†å‘" class="headerlink" title="5.3 æ‰“åŒ…åˆ†å‘"></a>5.3 æ‰“åŒ…åˆ†å‘</h4><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">$ helm <span class="keyword">package</span> ./</span><br><span class="line">Successfully packaged chart and saved it <span class="string">to:</span> <span class="regexp">/home/</span>work<span class="regexp">/kube/</span>helm<span class="regexp">/hello-world/</span>hello-world<span class="number">-0.1</span><span class="number">.0</span>.tgz</span><br></pre></td></tr></table></figure>
<p>åŒæ ·å¯ä»¥æ ¹æ®æ­¤ tgz åŒ…æ¥è¿›è¡Œå®‰è£…ã€å›æ»šã€å‡çº§<br><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ helm install hello-world-0.1.0.tgz</span><br><span class="line">$ helm rollback releasename 1 # releasename ç”± helm list è·å¾—ï¼Œ å›æ»šå‰ä¸€ä¸ªç‰ˆæœ¬</span><br><span class="line">$ helm<span class="built_in"> upgrade </span>releasename .  # æ›´æ–°è¿‡ chart å¹¶ä¸” package åï¼Œ<span class="built_in"> upgrade </span>æ›¿ä»£ install å‘½ä»¤ï¼Œ è¿›è¡Œæ›´æ–°</span><br></pre></td></tr></table></figure></p>
<p>å‚è€ƒï¼š<br><br><a href="https://www.kubernetes.org.cn/3435.html" target="_blank" rel="noopener">æ˜¯æ—¶å€™ä½¿ç”¨Helmäº†ï¼šHelm, Kubernetesçš„åŒ…ç®¡ç†å·¥å…·</a><br><br><a href="https://docs.helm.sh/using_helm/#role-based-access-control" target="_blank" rel="noopener">TILLER AND ROLE-BASED ACCESS CONTROL</a><br><br><a href="https://github.com/kubernetes/helm/tree/master/docs" target="_blank" rel="noopener">helm github docs</a><br><br><a href="https://daemonza.github.io/2017/02/20/using-helm-to-deploy-to-kubernetes/" target="_blank" rel="noopener">Using Helm to deploy to Kubernetes</a><br></p>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>helm</tag>
      </tags>
  </entry>
  <entry>
    <title>PostgreSql Connector</title>
    <url>/2020/05/28/debezium/pg/</url>
    <content><![CDATA[<p>åŸºäº pg çš„é€»è¾‘å¤åˆ¶åŠŸèƒ½, éœ€è¦ wal(logic) å’Œ é€»è¾‘è§£ç è¾“å‡ºæ’ä»¶çš„è¾…åŠ©, å®ç°æ•°æ®å˜æ›´äº‹ä»¶é€šçŸ¥</p>
<a id="more"></a>
<h2 id="1-PostgreSql-é…ç½®"><a href="#1-PostgreSql-é…ç½®" class="headerlink" title="1. PostgreSql é…ç½®"></a>1. PostgreSql é…ç½®</h2><ul>
<li><ol>
<li>ç‰ˆæœ¬: 9.6 or later (10.0 ä»¥ä¸Šæœ€å¥½)</li>
</ol>
</li>
<li><ol start="2">
<li>wal (write-ahead logs é¢„å†™æ—¥å¿—)</li>
</ol>
<ul>
<li><code>xlog</code>: pg 9.x çš„ wal å«åš xlog</li>
<li>lsn(localtion 9.x): lsn æ—¥å¿—å·, æ ‡è®° wal æ–‡ä»¶ä»¥åŠæ–‡ä»¶å†…åç§»é‡<ul>
<li>32ä½/32ä½</li>
<li>å·¦è¾¹ 32 ä½ï¼Œé€šè¿‡è®¡ç®—è·å¾— wal æ—¥å¿—çš„æ–‡ä»¶å: â€œtimeline + lsnè®¡ç®—â€</li>
<li>å³è¾¹ 32 ä½ï¼Œè·å¾—åç§»é‡</li>
</ul>
</li>
<li>é€»è¾‘è§£ç </li>
<li>output plugins</li>
<li>replication slots</li>
<li>wal_level: logic<ul>
<li>wal æ—¥å¿—ä¸­åŠ å…¥ä¿¡æ¯æ”¯æŒé€»è¾‘è§£ç , å¢å¤§ wal æ—¥å¿—, å°¤å…¶æ˜¯ updateã€delete</li>
<li>ä¸æ”¯æŒ DDLã€åˆ—å­˜ã€å‹ç¼©è¡¨çš„è§£ç , éœ€è¦é¢å¤–è§¦å‘å™¨å¤„ç† DDL, å¯ä»¥åšåˆ°è¡¨çº§è®¢é˜…</li>
</ul>
</li>
<li>ä¸ä½¿ç”¨çš„ replication slots è¦åŠæ—¶åˆ é™¤<ul>
<li>replication slots å­˜åœ¨å³ä¿è¯ä»åº“å®•æœºå, ä¸»åº“ä¸ä¼šåˆ é™¤ä»åº“ä¸ŠæŠ¥çš„ lsn ä¹‹åçš„ wal</li>
<li>connector çš„ ä¸ŠæŠ¥ lsn ä¸å˜åŒ–, é€ æˆ xlog å †ç§¯, å½±å“ç£ç›˜ç©ºé—´</li>
</ul>
</li>
</ul>
</li>
<li><ol start="3">
<li>é€»è¾‘è§£ç è¾“å‡ºæ’ä»¶</li>
</ol>
<ul>
<li>è§£ç å¹¶è¾“å‡º</li>
<li>pgoutput, 10+ é¢„è£…äº†</li>
<li>wal2json, åŸºäº json, ç”± wal2json ç¤¾åŒºç»´æŠ¤, éœ€è¦é¢„è£…</li>
<li>decoderbufs, åŸºäº protobuf, ç”± debezium ç¤¾åŒºç»´æŠ¤ï¼Œéœ€è¦é¢„è£…</li>
</ul>
</li>
<li><ol start="4">
<li>æ•°æ®åº“è®¾ç½®</li>
</ol>
<ul>
<li><ol>
<li>wal_level: logical</li>
</ol>
</li>
<li><ol start="2">
<li>max_replication_slots >= 1</li>
</ol>
</li>
<li><ol start="3">
<li>æƒé™</li>
</ol>
<ul>
<li>REPLICATION</li>
<li>LOGIN</li>
</ul>
</li>
<li><ol start="4">
<li>postgresql.conf</li>
</ol>
<ul>
<li>shared_preload_libraries = â€˜decoderbufs,wal2jsonâ€™ (é¢„è£…æ’ä»¶é…ç½®)</li>
<li>wal_level = logical</li>
<li>max_wal_senders = 1</li>
<li>max_replication_slots = 1</li>
</ul>
</li>
</ul>
</li>
<li><ol start="5">
<li>è¡¨è®¾ç½®</li>
</ol>
<ul>
<li><ol>
<li>REPLICA IDENTITY (å‰¯æœ¬èº«ä»½, å†³å®šäº†åœ¨ kafka message ä¸­ update å’Œ delete äº‹ä»¶ çš„ before å†…å®¹)</li>
</ol>
<ul>
<li>DEFAULT: ä»…æ˜¾ç¤ºä¸»é”®</li>
<li>NOTHING: nothing</li>
<li>FULL: å…¨éƒ¨ä¿¡æ¯</li>
<li>INDEX: ç´¢å¼•ä¿¡æ¯</li>
<li>æŸ¥çœ‹ sql:</li>
</ul>
</li>
</ul>
</li>
<li><ol start="6">
<li>æ•°æ®åº“å­—ç¬¦é›†</li>
</ol>
<ul>
<li>ä»…æ”¯æŒ UTF-8 å­—ç¬¦é›†<ul>
<li>connector æ— æ³•å¤„ç† å•å­—èŠ‚å­—ç¬¦é›†ä¸­çš„ åŒ…å«æ‰©å±• ASCII ç å­—ç¬¦é›†çš„å­—ç¬¦ä¸² (<code>TODO</code>: ä¸å¤ªç†è§£, åç»­è·Ÿè¿›)</li>
<li>Debezium currently supports only database with UTF-8 character encoding. With a single byte character encoding it is not possible to correctly process strings containing extended ASCII code characters.</li>
</ul>
</li>
</ul>
</li>
<li><ol start="7">
<li>å¸¸ç”¨å‘½ä»¤åˆé›†</li>
</ol>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">// superuser åˆ›å»º publication, ä½¿ç”¨ pgoutput æ—¶éœ€è¦äº‹å…ˆåˆ›å»º</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION $&#123;<span class="keyword">name</span>&#125; <span class="keyword">FOR</span> <span class="keyword">ALL</span> <span class="keyword">TABLES</span></span><br><span class="line"></span><br><span class="line">// publication</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> pg_publication;</span><br><span class="line"></span><br><span class="line">// <span class="keyword">show</span> publication <span class="keyword">tables</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> pg_publication_tables;</span><br><span class="line"></span><br><span class="line">// å¤åˆ¶æ’æ§½ åˆ—è¡¨</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pg_replication_slots;</span><br><span class="line"></span><br><span class="line">// wal ç­‰çº§</span><br><span class="line"><span class="keyword">show</span> wal_level;</span><br><span class="line"></span><br><span class="line">// æ–°å®‰è£…æ’ä»¶</span><br><span class="line"><span class="keyword">SHOW</span> shared_preload_libraries;</span><br><span class="line"></span><br><span class="line">// æŸ¥çœ‹ REPLICA IDENTITY</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	<span class="keyword">case</span> relreplident</span><br><span class="line">		<span class="keyword">when</span> <span class="string">'d'</span> <span class="keyword">then</span> <span class="string">'default'</span></span><br><span class="line">		<span class="keyword">when</span> <span class="string">'n'</span> <span class="keyword">then</span> <span class="string">'nothing'</span></span><br><span class="line">		<span class="keyword">when</span> <span class="string">'f'</span> <span class="keyword">then</span> <span class="string">'full'</span></span><br><span class="line">		<span class="keyword">when</span> <span class="string">'i'</span> <span class="keyword">then</span> <span class="string">'index'</span></span><br><span class="line">	<span class="keyword">end</span> <span class="keyword">as</span> replica_indentity,</span><br><span class="line">	relname</span><br><span class="line"><span class="keyword">from</span> pg_class <span class="keyword">where</span> relname <span class="keyword">in</span> (<span class="string">'products'</span>, <span class="string">'geom'</span>, <span class="string">'orders'</span>, <span class="string">'customers'</span>);</span><br><span class="line"></span><br><span class="line">// ä¿®æ”¹ REPLICA IDENTITY</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test_debezium_1 replica <span class="keyword">IDENTITY</span> <span class="keyword">full</span></span><br></pre></td></tr></table></figure>
<h3 id="1-1-å„å¹³å°é…ç½®æµç¨‹"><a href="#1-1-å„å¹³å°é…ç½®æµç¨‹" class="headerlink" title="1.1 å„å¹³å°é…ç½®æµç¨‹"></a>1.1 å„å¹³å°é…ç½®æµç¨‹</h3><ul>
<li>heroku æ— æ³•å®‰è£…æ’ä»¶, åªèƒ½ä½¿ç”¨ pg 10+ è‡ªå¸¦çš„é€»è¾‘è§£ç </li>
<li>Amazon RDS<ul>
<li><ol>
<li>rds.logical_replication: 1 (<code>TODO:</code> æ­¤å‚æ•°çš„ä¿®æ”¹æ„ä¹‰, è²Œä¼¼æ˜¯å¼€å…³)</li>
</ol>
</li>
<li><ol start="2">
<li>wal_level: logical; æ­¤å‚æ•°æ— æ³•ä¿®æ”¹, æ­¥éª¤ä¸€ä¿®æ”¹åè‡ªåŠ¨ç”Ÿæ•ˆ(æˆ–éœ€é‡å¯)</li>
</ol>
</li>
<li><ol start="3">
<li>plugin.name ä¿®æ”¹</li>
</ol>
<ul>
<li>10+ é»˜è®¤ pgoutput</li>
</ul>
</li>
<li><ol start="4">
<li>ç‰ˆæœ¬é™åˆ¶: wal2json ç‰ˆæœ¬å¤ªä½, ç±»å‹çº¦æŸä¿¡æ¯ä¸å®Œæ•´</li>
</ol>
<ul>
<li>Postgres 9.6: 9.6.10 and newer</li>
<li>Postgres 10: 10.5 and newer</li>
<li>Postgres 11: any version</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-connector"><a href="#2-connector" class="headerlink" title="2. connector"></a>2. connector</h2><h3 id="2-1-é€»è¾‘è§£ç æ’ä»¶"><a href="#2-1-é€»è¾‘è§£ç æ’ä»¶" class="headerlink" title="2.1 é€»è¾‘è§£ç æ’ä»¶"></a>2.1 é€»è¾‘è§£ç æ’ä»¶</h3><blockquote>
<p>éœ€è¦å®‰è£…åœ¨ postgresql server ä¸­, ç”¨ä½œè§£ç  wal ä¸ºå¯è¯» (åˆ›å»º replication slot æ—¶äº¦ä¼šä½¿ç”¨ï¼‰</p>
</blockquote>
<blockquote>
<p><a href="https://debezium.io/documentation/reference/0.10/postgres-plugins.html" target="_blank" rel="noopener">ç»†èŠ‚</a></p>
</blockquote>
<ul>
<li><a href="https://github.com/debezium/postgres-decoderbufs" target="_blank" rel="noopener">decoderbufs</a><ul>
<li>Debezium ç¤¾åŒºç»´æŠ¤, åŸºäº ProtoBuf</li>
</ul>
</li>
<li><a href="https://github.com/eulerto/wal2json" target="_blank" rel="noopener">wal2json</a><ul>
<li>wal2json ç¤¾åŒºç»´æŠ¤, åŸºäº json</li>
<li><a href="https://debezium.io/documentation/reference/0.10/connectors/postgresql.html#discrepance-between-plugins" target="_blank" rel="noopener">ä¸€å †é—®é¢˜, ä¹±ä¸ƒå…«ç³Ÿçš„</a></li>
</ul>
</li>
<li>pgoutput<ul>
<li>postgresql 10+ è‡ªå¸¦ (Debezium 0.10 å¯ç”¨)</li>
<li>æ»¡è¶³æ¡ä»¶çš„è¯ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ª; (å…¶ä½™æ˜¯ pg 10 ä¹‹å‰çš„ç‰ˆæœ¬ä½¿ç”¨)</li>
</ul>
</li>
</ul>
<h3 id="2-2-Connector"><a href="#2-2-Connector" class="headerlink" title="2.2 Connector"></a>2.2 Connector</h3><blockquote>
<p>æ³¨æ„äº‹é¡¹</p>
</blockquote>
<ul>
<li>connector ä¾èµ–äº pg çš„é€»è¾‘è§£ç åŠŸèƒ½, æ‰€ä»¥:<ul>
<li><code>æ— æ³•ç›‘æ§ DDL å˜åŒ–</code></li>
<li>é€»è¾‘è§£ç å™¨åŸå› , connector åªèƒ½ç›‘æ§é›†ç¾¤ä¸­<code>ä¸»æœåŠ¡å™¨</code>å˜åŒ–<ul>
<li>ä¸»æœåŠ¡å®•æœºæˆ–è¢«é™çº§, connector åœæ­¢</li>
<li>å¦‚æœæ­¤æœåŠ¡å™¨ä¼šè¢«æ¢å¤, é‡å¯ connector å³å¯</li>
<li>å¦‚æœå…¶ä»–æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨ï¼Œ connector é‡å¯å‰éœ€è¦å˜æ›´é…ç½®</li>
</ul>
</li>
</ul>
</li>
<li>ä¸»é”®æ›´æ”¹æœ‰é£é™©: <a href="https://debezium.io/documentation/reference/0.10/connectors/postgresql.html#streaming-changes" target="_blank" rel="noopener">æµå¼ä¿®æ”¹</a> -&gt; Note (TODO: ææ¸…æ¥šæ€ä¹ˆå›äº‹)<ul>
<li>è²Œä¼¼æ²¡ä»€ä¹ˆå½±å“<ul>
<li>æ— ä¸»é”®çš„è¡¨, æ•°æ®æ²¡æœ‰ key, ä¸æ˜¯ä¸º null</li>
<li>å°†ä¸»é”®å»é™¤å(ä¸æ˜¯åˆ åˆ—), æ•°æ® key ä»ä¸ºåŸæ¥çš„ key ç»“æ„</li>
</ul>
</li>
</ul>
</li>
<li>å½“ replication slot ä¸¢å¤±æ—¶, éœ€è¦é‡å¯ task æ¥è‡ªåŠ¨ initReplicationSlot</li>
</ul>
<h3 id="2-3-connector-å·¥ä½œæµç¨‹"><a href="#2-3-connector-å·¥ä½œæµç¨‹" class="headerlink" title="2.3 connector å·¥ä½œæµç¨‹"></a>2.3 connector å·¥ä½œæµç¨‹</h3><ul>
<li>snapshot<ul>
<li><ol>
<li>è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ« SERIALIZABLE, READ ONLY, DEFERRABLE (DEFERRABLE ä¿è¯äº†é•¿æ—¶é—´æ‰§è¡Œæ—¶ä¸ä¸å…¶ä»–ä¸²è¡Œäº‹åŠ¡å†²çª)</li>
</ol>
</li>
<li><ol start="2">
<li>å¯¹æ¯å¼ è¡¨åŠ é” SHARE UPDATE EXCLUSIVE MODE (é”æœ‰ç‚¹ä¹±, TODO: æ•´ç†å¹¶è¯¦è§£), ç¡®ä¿è¡¨ç»“æ„ä¸è¢«æ›´æ”¹</li>
</ol>
</li>
<li><ol start="3">
<li>è·å–å½“å‰äº‹åŠ¡å¼€å§‹æ—¶ wal(lsn) ä½ç½®, ä¸ºäº†åœ¨ snaphsot åä»è¯¥ä½ç½®å¼€å§‹ç›‘æ§æ•°æ®, é˜²æ­¢æ•°æ®é—æ¼</li>
</ol>
</li>
<li><ol start="4">
<li>è·å– schema, å¦‚æœå¼€å¯æ•°æ®åŒæ­¥, åŒæ—¶ä¼šä¸ºæ¯è¡Œç°æœ‰æ•°æ®ç”Ÿæˆ read äº‹ä»¶, åŒæ­¥è‡³ kafka å¯¹åº” topic</li>
</ol>
</li>
<li><ol start="5">
<li>commit</li>
</ol>
</li>
<li><ol start="6">
<li>è®°å½•å¿«ç…§å®Œæˆ offset (? å’Œ æ­¥éª¤ 3 çš„å…³ç³» ? ä¸ºäº† snapshot æœªå®Œæˆæ—¶æ„å¤–é‡å¯é‡æ–°å¼€å§‹)</li>
</ol>
</li>
</ul>
</li>
<li>Streaming Changes<ul>
<li>initReplicationSlot (replication slot, æ²¡æœ‰åˆ™åˆ›å»º, åˆ¤æ–­æ˜¯å¦è¢«å…¶ä»–è¿›ç¨‹å ç”¨)</li>
<li>initPublication (pgoutput æ’ä»¶éœ€è¦ <code>publication</code> æ¥è¿›è¡Œé™å®šè¡¨ç™½åå•, æ²¡æœ‰åˆ™åˆ›å»º all tables)<ul>
<li>å¯ä»¥äº‹å…ˆç”¨ superuser åˆ›å»º, connector é»˜è®¤ publication ä¸º <code>dbz_publication</code></li>
</ul>
</li>
<li>ä»ä¸Šè¿°æ­¥éª¤ 3 ä¸­è·å–åˆ°çš„ LSNs (Log Sequence Numbers) å¼€å§‹</li>
</ul>
</li>
</ul>
<h3 id="2-4-ç±»å‹è½¬æ¢"><a href="#2-4-ç±»å‹è½¬æ¢" class="headerlink" title="2.4 ç±»å‹è½¬æ¢"></a>2.4 ç±»å‹è½¬æ¢</h3><blockquote>
<p>å¤§ä½“ç±»å‹è½¬æ¢å’Œ mysql ç±»ä¼¼, ä¸‹é¢åˆ—å‡ºç‰¹æ®Šç‚¹</p>
</blockquote>
<ul>
<li>HSTORE =&gt; String (â€˜â€œaâ€ =&gt; â€œbâ€â€˜ =&gt; â€œ{â€œaâ€: â€œbâ€}â€)</li>
<li>ç½‘ç»œåœ°å€ç±»å‹<ul>
<li>INETã€CIDRã€MACADDRã€MACADDR8 =&gt; String</li>
</ul>
</li>
<li>PostGIS Types (ç©ºé—´ç±»å‹è½¬åŒ–) (å¾…ç»­â€¦ æœ‰ç©ºå†è¯´)</li>
<li>Toasted: (å­˜å‚¨å†…å®¹è¶…è¿‡ 8 kb, é‡‡ç”¨ Toasted å­˜å‚¨, å…·ä½“å†è¯´å§)</li>
</ul>
<h3 id="2-5-éƒ¨ç½²"><a href="#2-5-éƒ¨ç½²" class="headerlink" title="2.5 éƒ¨ç½²"></a>2.5 éƒ¨ç½²</h3><ul>
<li><ol>
<li>å®‰è£…é€»è¾‘è§£ç æ’ä»¶ (decoderbufsã€wal2json â€¦)</li>
</ol>
<ul>
<li>pg 10+ é»˜è®¤å®‰è£… pgoutput, æ¨èä½¿ç”¨ (pgoutput éœ€è¦ superuser æƒé™åˆ›å»º publication, æˆ–è€…äº‹å…ˆåˆ›å»º)</li>
</ul>
</li>
<li><ol start="2">
<li>é…ç½® pg æ”¯æŒé€»è¾‘å¤åˆ¶ (è§ç¬¬ä¸€å¤§é¡¹)</li>
</ol>
</li>
<li><ol start="3">
<li>POST åˆ›å»º connector</li>
</ol>
<ul>
<li><code>name</code>: â€˜â€™ (connector åç§°, å”¯ä¸€æ€§)</li>
<li><code>config</code>:<ul>
<li><code>connector.class</code>: â€œio.debezium.connector.postgresql.PostgresConnectorâ€</li>
<li><code>tasks.max</code>: 1</li>
<li><code>plugin.name</code>: è§æ­¥éª¤ä¸€</li>
<li><code>slot.name</code>: é€»è¾‘è§£ç æ§½, ä¿è¯ wal ä¸è¢«æ¸…ç†, æ‰€ä»¥, è¦ç‰¹åˆ«æ³¨æ„ (å’Œ connector ä¸€å¯¹ä¸€)</li>
<li><code>publication</code>: å­˜åœ¨é»˜è®¤å€¼, dbz_publication;<ul>
<li>ä½¿ç”¨ pgoutput æ—¶, éœ€åˆ›å»º;</li>
<li>éœ€è¦ä½¿ç”¨ supuser åˆ›å»º, ç”±äºç›®å‰åŠŸèƒ½ç¼ºé™·, å¯ä»¥äº‹å…ˆåˆ›å»º all tables çš„ publication</li>
</ul>
</li>
<li><code>slot.drop_on_stop</code>: true or false<ul>
<li>connector åœæ­¢å (stop å®ä¾‹ ?), æ˜¯å¦åˆ é™¤ replication slot</li>
<li>æ¨èæµ‹è¯•ç¯å¢ƒè®¾ç½®ä¸º true, é˜²æ­¢ wal å¤§é‡å †ç§¯, å ç”¨ç£ç›˜ç©ºé—´</li>
<li>ç”Ÿäº§ç¯å¢ƒè®¾ç½®ä¸º false, ä½†ä¸€å®šè¦æœ‰ connector å®•æœºçš„å¤„ç†é¢„æ¡ˆä»¥åŠç£ç›˜ç©ºé—´é¢„ä¼°, ä¸ç„¶å‡†å¤‡è¿æ¥ç£ç›˜<code>çˆ†æ»¡</code>å§</li>
<li><strong><em><code>æ³¨æ„</code></em></strong> : å½“ä¸º true æ—¶, connector é‡å¯ä¼šåˆ é™¤ã€é‡å»º slot, ä¼šå¯¼è‡´<code>æ•°æ®ä¸¢å¤±</code></li>
</ul>
</li>
<li><code>database.hostname</code></li>
<li><code>database.port</code></li>
<li><code>database.user</code></li>
<li><code>database.password</code></li>
<li><code>database.dbname</code>: åº“å</li>
<li><code>database.server.name</code>: æœåŠ¡å, å”¯ä¸€æ€§<ul>
<li>topic name: <code>${database.server.name}.${schema name}.${table name}</code></li>
</ul>
</li>
<li><code>schema.whitelis</code>t / <code>blacklist</code></li>
<li><code>table.whitelist</code> / <code>blacklist</code></li>
<li><code>column.blacklist</code>: schemaName.tableName.columnName</li>
<li><code>decimal.handling.mode</code>: â€œstringâ€ (Decimal ä»¥ string å½¢å¼å­˜åœ¨)</li>
<li><code>tombstones.on.delete</code>: true or false (kafka å¢“ç¢‘äº‹ä»¶)</li>
<li><code>snapshot.mode</code>:<ul>
<li><code>initial</code>(default): ä»…åœ¨ connector åˆ›å»ºæ—¶æ‰§è¡Œå¿«ç…§</li>
<li><code>always</code>: connector <code>æ¯æ¬¡å¯åŠ¨</code>æ—¶æ‰§è¡Œå¿«ç…§</li>
<li><code>never</code>: å­—é¢æ„æ€</li>
<li><code>initial_only</code>: åªæ‰§è¡Œå¿«ç…§, åç»­çš„æ•°æ®å˜åŒ–æµä¸åšå¤„ç†</li>
<li><code>exported</code>: ä» replication slot åˆ›å»ºçš„æ—¶é—´èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œ, æ— é”</li>
<li><code>custom</code>: è‡ªå·±å†™ä»£ç , åŒæ—¶éœ€è¦åˆ¶å®š <code>snapshot.custom.class</code></li>
</ul>
</li>
<li><code>snapshot.lock.timeout.ms</code>: 10000 (è·å–è¡¨é”è¶…æ—¶æ—¶é—´)</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"pg_inventory_1"</span>,</span><br><span class="line">    <span class="attr">"config"</span>: &#123;</span><br><span class="line">	    <span class="attr">"connector.class"</span>: <span class="string">"io.debezium.connector.postgresql.PostgresConnector"</span>,</span><br><span class="line">	    <span class="attr">"database.user"</span>: <span class="string">"postgres"</span>,</span><br><span class="line">	    <span class="attr">"database.dbname"</span>: <span class="string">"postgres"</span>,</span><br><span class="line">	    <span class="attr">"slot.name"</span>: <span class="string">"pg_inventory_1"</span>,</span><br><span class="line">	    <span class="attr">"database.server.name"</span>: <span class="string">"pg_inventory_1"</span>,</span><br><span class="line">	    <span class="attr">"database.port"</span>: <span class="string">"5432"</span>,</span><br><span class="line">	    <span class="attr">"plugin.name"</span>: <span class="string">"pgoutput"</span>,</span><br><span class="line">	    <span class="attr">"schema.whitelist"</span>: <span class="string">"inventory"</span>,</span><br><span class="line">	    <span class="attr">"table.whitelist"</span>: <span class="string">"inventory.orders"</span>,</span><br><span class="line">	    <span class="attr">"slot.drop_on_stop"</span>: <span class="string">"true"</span>,</span><br><span class="line">	    <span class="attr">"decimal.handling.mode"</span>: <span class="string">"string"</span>,</span><br><span class="line">	    <span class="attr">"database.hostname"</span>: <span class="string">"192.168.4.21"</span>,</span><br><span class="line">	    <span class="attr">"database.password"</span>: <span class="string">"postgres"</span>,</span><br><span class="line">	    <span class="attr">"snapshot.mode"</span>: <span class="string">"never"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-é—®é¢˜"><a href="#3-é—®é¢˜" class="headerlink" title="3. é—®é¢˜"></a>3. é—®é¢˜</h2><ul>
<li><ol>
<li>æ›´æ–°é…ç½®æ—¶, æŠ¥é”™, ä¸”å‡ºç°æ•°æ®ä¸¢å¤±</li>
</ol>
<ul>
<li>å¤ç°æ­¥éª¤<ul>
<li>ä¸€åˆ‡æ­£å¸¸å</li>
<li>æ²¡ 200ms, update\delete\insert pg</li>
<li>kafka æ•°æ®æ­£å¸¸</li>
<li>æ›´æ–° table.whitelist</li>
<li>å¾…æ›´æ–°å®Œæˆå, å‘ç°æ•°æ®ä¸¢å¤±</li>
</ul>
</li>
<li>åŸå› : slot.drop_on_stop: true æ—¶, connector é‡å¯, åˆ™ slot åˆ é™¤åé‡å»º, é€ æˆæ•°æ®ä¸¢å¤±</li>
</ul>
</li>
</ul>
<p>å‚è€ƒæ–‡æ¡£: <br></p>
<ol>
<li><a href="https://www.postgresql.org/docs/10/logical-replication.html" target="_blank" rel="noopener">é€»è¾‘å¤åˆ¶</a> <br></li>
<li><a href="https://juejin.im/entry/58ba3279570c350062124bc9" target="_blank" rel="noopener">pg 10.0 é€»è¾‘å¤åˆ¶</a> <br></li>
<li><a href="https://jdbc.postgresql.org/documentation/head/replication.html" target="_blank" rel="noopener">PG JDBC logical replication API</a> <br></li>
</ol>
]]></content>
      <categories>
        <category>Debezium</category>
      </categories>
      <tags>
        <tag>Debezium</tag>
      </tags>
  </entry>
  <entry>
    <title>å¾®ä¿¡å°æ¸¸æˆç›®å½•ç»“æ„</title>
    <url>/2018/01/14/wechat_game/dir-structure-md/</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦è®²è¿°ï¼Œ å¦‚ä½•å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå°æ¸¸æˆé¡¹ç›®å¹¶ä¸”é’ˆå¯¹å…¶ç›®å½•ç»“æ„è¿›è¡Œç®€å•è®²è§£ã€‚<br><a id="more"></a></p>
<h3 id="1-åˆ›å»ºé¡¹ç›®"><a href="#1-åˆ›å»ºé¡¹ç›®" class="headerlink" title="1. åˆ›å»ºé¡¹ç›®"></a>1. åˆ›å»ºé¡¹ç›®</h3><p>é¦–å…ˆæ–°å»ºé¡¹ç›®ï¼Œç›®å‰å°æ¸¸æˆä¸æä¾›å…¬å¼€æ³¨å†Œï¼Œå¯ç‚¹å‡»ä½“éªŒå°æ¸¸æˆä½¿ç”¨æ—  AppID æ¨¡å¼ï¼ˆåˆ›å»ºæ—¶å¦‚æœå»ºç«‹å¿«é€Ÿå¯åŠ¨æ¨¡æ¿ï¼Œéœ€è¦é€‰æ‹©ä¸€ä¸ªç©ºçš„ç›®å½•ï¼‰ã€‚<img src="../../../../../images/wechat_game/createProject.jpg" alt></p>
<h3 id="2-å¾®ä¿¡é¢„è§ˆ"><a href="#2-å¾®ä¿¡é¢„è§ˆ" class="headerlink" title="2. å¾®ä¿¡é¢„è§ˆ"></a>2. å¾®ä¿¡é¢„è§ˆ</h3><p>é€‰æ‹©å»ºç«‹å¿«é€Ÿå¯åŠ¨æ¨¡æ¿åï¼Œå°†ä¼šç”Ÿæˆä¸€ä¸ªå°æ¸¸æˆé¡¹ç›®ï¼Œå¹¶åœ¨å¼€å‘å·¥å…·ä¸­æ‰“å¼€ï¼Œè¿™æ—¶ç‚¹å‡»å¼€å‘å·¥å…·å³ä¸Šè§’çš„é¢„è§ˆæŒ‰é’®ï¼Œä¼šç”Ÿæˆå¯¹åº”äºŒç»´ç ï¼Œå¾®ä¿¡æ‰«ç å³å¯ã€‚<br><img src="../../../../../images/wechat_game/yulan.jpg" alt> </p>
<h3 id="3-ç›®å½•ç»“æ„"><a href="#3-ç›®å½•ç»“æ„" class="headerlink" title="3. ç›®å½•ç»“æ„"></a>3. ç›®å½•ç»“æ„</h3><p><code>./audio</code>: éŸ³é¢‘ç›®å½•æ–‡ä»¶ <br><br><code>./images</code>: å›¾ç‰‡æ–‡ä»¶ç›®å½• <br><br><code>./js</code>: ä¸»è¦æºä»£ç ç›®å½• <br><br><code>./game.js</code>: ä¸»å…¥å£æ–‡ä»¶ <br><br><code>./game.json</code>: é…ç½®æ–‡ä»¶</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">./js</span><br><span class="line">â”œâ”€â”€ base                                   <span class="comment">// å®šä¹‰æ¸¸æˆå¼€å‘åŸºç¡€ç±»</span></span><br><span class="line">â”‚   â”œâ”€â”€ animatoin.js                       <span class="comment">// å¸§åŠ¨ç”»çš„ç®€æ˜“å®ç°</span></span><br><span class="line">â”‚   â”œâ”€â”€ pool.js                            <span class="comment">// å¯¹è±¡æ± çš„ç®€æ˜“å®ç°</span></span><br><span class="line">â”‚   â””â”€â”€ sprite.js                          <span class="comment">// æ¸¸æˆåŸºæœ¬å…ƒç´ ç²¾çµç±»</span></span><br><span class="line">â”œâ”€â”€ libs</span><br><span class="line">â”‚   â”œâ”€â”€ <span class="keyword">symbol</span>.js                          <span class="comment">// ES6 Symbolç®€æ˜“å…¼å®¹</span></span><br><span class="line">â”‚   â””â”€â”€ weapp-adapter.js                   <span class="comment">// å°æ¸¸æˆé€‚é…å™¨</span></span><br><span class="line">â”œâ”€â”€ npc</span><br><span class="line">â”‚   â””â”€â”€ enemy.js                           <span class="comment">// æ•Œæœºç±»</span></span><br><span class="line">â”œâ”€â”€ player</span><br><span class="line">â”‚   â”œâ”€â”€ bullet.js                          <span class="comment">// å­å¼¹ç±»</span></span><br><span class="line">â”‚   â””â”€â”€ index.js                           <span class="comment">// ç©å®¶ç±»</span></span><br><span class="line">â”œâ”€â”€ runtime</span><br><span class="line">â”‚   â”œâ”€â”€ <span class="built_in">background</span>.js                      <span class="comment">// èƒŒæ™¯ç±»</span></span><br><span class="line">â”‚   â”œâ”€â”€ gameinfo.js                        <span class="comment">// ç”¨äºå±•ç¤ºåˆ†æ•°å’Œç»“ç®—ç•Œé¢</span></span><br><span class="line">â”‚   â””â”€â”€ music.js                           <span class="comment">// å…¨å±€éŸ³æ•ˆç®¡ç†å™¨</span></span><br><span class="line">â”œâ”€â”€ databus.js                             <span class="comment">// ç®¡æ§æ¸¸æˆçŠ¶æ€</span></span><br><span class="line">â””â”€â”€ main.js                                <span class="comment">// æ¸¸æˆå…¥å£ä¸»å‡½æ•°</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æºç åˆ†æï¼šå‚è€ƒ <a href="https://segmentfault.com/a/1190000012646888" target="_blank" rel="noopener">segmentfaultçš„ä¸€ç¯‡æ–‡ç« </a> </p>
</blockquote>
]]></content>
      <categories>
        <category>wechat</category>
      </categories>
      <tags>
        <tag>wechat_game</tag>
      </tags>
  </entry>
  <entry>
    <title>kuberneteså…¥é—¨</title>
    <url>/2018/01/15/k8s/k8s-first-md/</url>
    <content><![CDATA[<p>é¦–å…ˆï¼Œ Kubernetes(k8s)æ˜¯ä¸€ä¸ªå…¨æ–°çš„åŸºäºå®¹å™¨(docker/Rocket)æŠ€æœ¯çš„åˆ†å¸ƒå¼æ¶æ„è§£å†³æ–¹æ¡ˆã€‚å…¶æ¬¡ï¼Œæ˜¯ä¸€ä¸ªå¼€æ”¾çš„å¼€å‘å¹³å°ï¼Œä¸åŒçš„æ˜¯æ²¡æœ‰é™å®šä»»ä½•å˜æˆæ¥å£ã€è¯­è¨€ã€æ¡†æ¶ï¼Œå¯ä»¥å¾ˆç®€å•çš„å°†ç³»ç»Ÿæ˜ å°„ä¸ºk8sçš„Serviceã€‚æœ€åï¼Œ æ˜¯ä¸€ä¸ªä¸€ç«™å¼çš„å®Œå¤‡çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ”¯æ’‘å¹³å°ï¼Œk8så…·æœ‰å®Œå¤‡çš„é›†ç¾¤ç®¡ç†èƒ½åŠ›ï¼ŒåŒ…æ‹¬å¤šå±‚æ¬¡çš„å®‰å…¨é˜²æŠ¤å’Œå‡†å…¥æœºåˆ¶ã€å¤šç§Ÿæˆ·çš„åº”ç”¨æ”¯æ’‘èƒ½åŠ›ã€é€æ˜çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°æœºåˆ¶ã€å†…å»ºæ™ºèƒ½è´Ÿè½½å‡è¡¡å™¨ã€æ•…éšœå‘ç°å’Œè‡ªæˆ‘ä¿®å¤èƒ½åŠ›ã€æœåŠ¡æ»šåŠ¨å‡çº§å’Œåœ¨çº¿æ‰©å®¹èƒ½åŠ›ã€å¯æ‰©å±•çš„èµ„æºè‡ªåŠ¨è°ƒåº¦æœºåˆ¶ï¼Œä»¥åŠå¤šç²’åº¦çš„èµ„æºé…é¢ç®¡ç†èƒ½åŠ›ã€‚åŒæ—¶æä¾›äº†æ¶µç›–å¼€å‘ã€éƒ¨ç½²æµ‹è¯•ã€è¿ç»´ç›‘æ§åœ¨å†…çš„å„ä¸ªç¯èŠ‚çš„ç®¡ç†å·¥å…·ã€‚<br><a id="more"></a></p>
<h3 id="1-Master-ä¸»èŠ‚ç‚¹"><a href="#1-Master-ä¸»èŠ‚ç‚¹" class="headerlink" title="1. Master(ä¸»èŠ‚ç‚¹)"></a>1. Master(ä¸»èŠ‚ç‚¹)</h3><p>ç»„æˆï¼š <br><br>1ï¼‰APIServerï¼š è´Ÿè´£å¯¹å¤–æä¾› RESTful çš„ k8s APIæœåŠ¡ï¼Œå®ƒæ˜¯ç³»ç»Ÿç®¡ç†æŒ‡ä»¤çš„ç»Ÿä¸€å…¥å£ï¼Œä»»ä½•å¯¹èµ„æºè¿›è¡Œå¢åˆ æ”¹æŸ¥çš„æ“ä½œéƒ½è¦äº¤ç»™APIServerå¤„ç†åå†æäº¤ç»™etcd<br><br>2ï¼‰schedulerï¼š è´Ÿè´£è°ƒåº¦podåˆ°åˆé€‚çš„Nodeä¸Š<br><br>3ï¼‰Controller managerï¼š è´Ÿè´£ç®¡ç†èµ„æºæ§åˆ¶å™¨ï¼ˆæ¯ä¸ªèµ„æºä¸€èˆ¬éƒ½å¯¹åº”æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ï¼‰<br><br>4ï¼‰etcdï¼š å­˜å‚¨å„ä¸ªèµ„æºçš„çŠ¶æ€ï¼Œä»è€Œå®ç°äº†Restfulçš„API<br></p>
<h3 id="2-Node-èŠ‚ç‚¹"><a href="#2-Node-èŠ‚ç‚¹" class="headerlink" title="2. Node(èŠ‚ç‚¹)"></a>2. Node(èŠ‚ç‚¹)</h3><p>ç»„æˆï¼š<br><br>1ï¼‰Runtimeï¼š æŒ‡çš„æ˜¯å®¹å™¨è¿è¡Œç¯å¢ƒ<br><br>2ï¼‰kube-proxyï¼š æœåŠ¡å‘ç°å’Œåå‘ä»£ç†åŠŸèƒ½<br><br>3ï¼‰kubeletï¼š æ˜¯Masteråœ¨æ¯ä¸ªNodeèŠ‚ç‚¹ä¸Šé¢çš„agentï¼Œ è´Ÿè´£ç»´æŠ¤å’Œç®¡ç†è¯¥Nodeä¸Šé¢çš„ç”±k8såˆ›å»ºçš„æ‰€æœ‰å®¹å™¨<br></p>
<p>åˆ›å»ºè¿‡ç¨‹ï¼š<br><br>1ï¼‰åˆ›å»ºï¼š k8såœ¨ç‰©ç†æœºã€è™šæ‹Ÿæœºæˆ–å…¶ä»–äº‘æœåŠ¡èµ„æºä¸Šåˆ›å»ºä¸€ä¸ª node å¯¹è±¡ï¼Œ å¹¶å¯¹å…¶è¿›è¡Œä¸€ç³»åˆ—å¥åº·æ£€æŸ¥ï¼ˆæ˜¯å¦å¯ä»¥è”é€šã€æœåŠ¡æ˜¯å¦æ­£ç¡®å¯åŠ¨ã€æ˜¯å¦å¯ä»¥åˆ›å»ºpodç­‰ï¼‰ï¼Œç„¶ååœ¨é›†ç¾¤ä¸­æ ‡è®°å…¶çŠ¶æ€ã€‚<br><br>1ï¼‰ç®¡ç†ï¼š k8s master é€šè¿‡ Node Controller ç®¡ç†é›†ç¾¤å†… node çš„ä¿¡æ¯åŒæ­¥ã€ç”Ÿå‘½å‘¨æœŸç­‰ï¼›<br><br>1ï¼‰æ³¨å†Œ: k8s æ¨èè‡ªæ³¨å†Œï¼Œ ç”± kubelet å‘ Apiserver æ³¨å†Œè‡ªå·±ï¼Œ ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ³¨å†Œã€‚<br></p>
<h3 id="3-Pod"><a href="#3-Pod" class="headerlink" title="3. Pod"></a>3. Pod</h3><p>åœ¨ k8s ä¸­ï¼Œ Pod æ˜¯å…¶åŸºæœ¬æ“ä½œå•å…ƒï¼Œä¹Ÿæ˜¯åº”ç”¨è¿è¡Œçš„è½½ä½“ã€‚Pod åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªç›¸å…³çš„å®¹å™¨ï¼ˆ<strong>å¯ä»¥çœ‹æˆåº”ç”¨å±‚çš„é€»è¾‘å®¿ä¸»æœº</strong>ï¼‰ã€‚Pod å¯ä»¥è®¤ä¸ºæ˜¯å®¹å™¨çš„ä¸€ç§å»¶ä¼¸æ‰©å±•ï¼Œä¸€ä¸ªPodä¹Ÿæ˜¯ä¸€ä¸ªéš”ç¦»ä½“ï¼Œè€ŒPodå†…éƒ¨åŒ…å«çš„ä¸€ç»„å®¹å™¨åˆæ˜¯å…±äº«çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒPodä¸­çš„å®¹å™¨å¯ä»¥è®¿é—®å…±åŒçš„æ•°æ®å·æ¥å®ç°æ–‡ä»¶ç³»ç»Ÿçš„å…±äº«ã€‚</p>
<blockquote>
<p>Pod åŒ docker ä¸€æ ·ï¼Œ é€šè¿‡æ•°æ®å·æŒ‚è½½æ¥å®ç°æ•°æ®æŒä¹…åŒ–ï¼ˆæœ¬åœ°ã€ç½‘ç»œç­‰æ•°æ®å·ï¼‰ã€‚<br><br>Pod å°è£… docker çš„ç›®çš„ï¼š docker å®¹å™¨é€šä¿¡å— docker ç½‘ç»œæœºåˆ¶é™åˆ¶ï¼ˆâ€“linkï¼‰ï¼Œé€šè¿‡ Pod æ¦‚å¿µå°†å®¹å™¨ç»„åˆåœ¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºå†…ï¼Œå®ç°å®¹å™¨é€šè¿‡ localhost é€šä¿¡ï¼ˆå…±äº« PID å‘½åç©ºé—´ï¼Œç½‘ç»œå‘½åç©ºé—´ï¼Œä¸»æœºåï¼Œå­˜å‚¨å·ç­‰ï¼Œå®ç°è¿›ç¨‹é€šä¿¡ç­‰ï¼‰ã€‚<br></p>
</blockquote>
<p>Pod å®šä¹‰ï¼š é€šè¿‡Yamlæˆ–Jsonæ ¼å¼çš„é…ç½®æ–‡ä»¶æ¥å®Œæˆ, ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><br><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: Pod</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">    <span class="attribute">name</span>: redis-slave</span><br><span class="line">    <span class="attribute">labels</span>:</span><br><span class="line">        <span class="attribute">name</span>: redis-slave</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">    <span class="attribute">containers</span>:</span><br><span class="line">    - <span class="attribute">name</span>: slave</span><br><span class="line">      <span class="attribute">image</span>: kubeguide/guestbook-redis-slave</span><br><span class="line">      commandï¼š [<span class="string">'sh'</span>]</span><br><span class="line">      <span class="attribute">env</span>:</span><br><span class="line">    - <span class="attribute">name</span>: GET_HOSTS_FROM</span><br><span class="line">      <span class="attribute">value</span>: env</span><br><span class="line">      <span class="attribute">ports</span>:</span><br></pre></td></tr></table></figure></p>
<p>Pod åŸºæœ¬æ“ä½œï¼š <br><br>å¢ï¼š<code>kubectl create -f xxx.yaml</code><br><br>åˆ ï¼š <code>kubectl delete pod yourPodName</code> <br><br>æ”¹ï¼š <code>kubectl replace /path/to/yourNewYaml.yaml</code><br><br>æŸ¥ï¼š <code>kubectl get pod yourPodName</code>ï¼Œ <code>kubectl describe pod yourPodName</code> </p>
<h3 id="4-Label"><a href="#4-Label" class="headerlink" title="4. Label"></a>4. Label</h3><p>Labelå®šä¹‰å¦‚ Podã€Serviceã€RCã€Node ç­‰å¯¹è±¡çš„å¯è¯†åˆ«å±æ€§ï¼ˆkey/value é”®å€¼å¯¹ï¼‰ï¼Œç”¨æ¥å¯¹å®ƒä»¬è¿›è¡Œç®¡ç†å’Œé€‰æ‹©ï¼Œå¯ä»¥å¦‚ä¸Šé¢ç¤ºä¾‹é‚£æ ·å®šä¹‰ä»¥ä¾›åˆ›å»ºæ—¶é™„åŠ åˆ°å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºåé€šè¿‡APIè¿›è¡Œç®¡ç†ã€‚é€šè¿‡ <code>selector</code> æ¥è¿›è¡Œ label é€‰æ‹©ï¼Œè¿›è¡Œèµ„æºä¹‹é—´çš„å…³è”ã€‚<br><br>å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œ å°†è¯¥èµ„æºä¸ <code>nameï¼š redis-slave</code> çš„èµ„æºè¿›è¡Œå…³è”ã€‚<br><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="symbol">selector:</span></span><br><span class="line"><span class="symbol">  name:</span> redis-slave</span><br></pre></td></tr></table></figure></p>
<h3 id="5-Replication-Controllerï¼ˆRCï¼‰"><a href="#5-Replication-Controllerï¼ˆRCï¼‰" class="headerlink" title="5. Replication Controllerï¼ˆRCï¼‰"></a>5. Replication Controllerï¼ˆRCï¼‰</h3><p>ç”¨äºå®šä¹‰ Pod å‰¯æœ¬çš„æ•°é‡ï¼Œ åœ¨Masterå†…ï¼ŒController Managerè¿›ç¨‹é€šè¿‡RCçš„å®šä¹‰æ¥å®ŒæˆPodçš„åˆ›å»ºã€ç›‘æ§ã€å¯åœç­‰æ“ä½œã€‚å¤šåœå°‘å¯ï¼Œä¿è¯é›†ç¾¤ä¸­è¿è¡Œç€ç”¨æˆ·æœŸæœ›çš„å‰¯æœ¬æ•°é‡ã€‚<br><br>ä¸ Pod ç±»ä¼¼ï¼Œ é€šè¿‡ yaml æˆ– json é…ç½®æ–‡ä»¶æ¥å®šä¹‰ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼Œ ç›¸æ¯” Pod å®šä¹‰ï¼Œ <code>kind</code> å˜ä¸º ReplicationControllerï¼Œ å¦å¤–å¤šäº† <code>replicas</code>ï¼Œ ä»¥åŠ Label é€‰æ‹©å™¨ <code>selector</code>ã€‚ åŒæ—¶åœ¨ <code>template</code> ä¸­å®šä¹‰äº† Podï¼Œ ç”±äº RC ç‰¹æ€§ï¼Œé€šå¸¸é€šè¿‡è¿™ç§å½¢å¼æ¥åˆ›å»ºèµ„æºã€‚<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-slave</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis-slave</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis-slave</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># template å†…å®šä¹‰ Podï¼Œ </span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-slave</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis-slave</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">slave</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kubeguide/guestbook-redis-slave</span></span><br><span class="line">        <span class="string">commandï¼š</span> <span class="string">['sh']</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">env</span></span><br><span class="line">        <span class="attr">ports:</span></span><br></pre></td></tr></table></figure></p>
<h3 id="6-Deployment"><a href="#6-Deployment" class="headerlink" title="6. Deployment"></a>6. Deployment</h3><blockquote>
<p>åç»­å‘å±•ä¸­ï¼Œå‡ºç°äº† Replica Set â€“ ä¸‹ä¸€ä»£Replication Controllerã€‚ç›¸æ¯”ä¸ RC <code>selector</code> çš„ key/valueï¼Œ RS è¿˜æ”¯æŒé›†åˆæ“ä½œï¼ˆin,notin ..etcï¼‰,åç»­è‚¯å®šä¼šåŠ å…¥æ›´å¤šåŠŸèƒ½.<br>Deploymentä½¿ç”¨äº†Replica Setï¼Œæ˜¯æ›´é«˜ä¸€å±‚çš„æ¦‚å¿µã€‚åŒæ—¶ï¼Œä¸ RC ç›¸æ¯”ï¼Œ Deployment æ‹¥æœ‰æ›´åŠ çµæ´»å¼ºå¤§çš„å‡çº§ã€å›æ»šåŠŸèƒ½ã€‚é™¤ééœ€è¦è‡ªå®šä¹‰å‡çº§åŠŸèƒ½æˆ–æ ¹æœ¬ä¸éœ€è¦å‡çº§ Podï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ Deployment è€Œä¸ç›´æ¥ä½¿ç”¨Replica Set.<br><br>Deployment çš„å®šä¹‰ ä¸ RC ç±»ä¼¼ï¼Œ ä¸»è¦å˜åŒ–ï¼š<br><figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="7-Serviceï¼ˆæœåŠ¡ï¼‰"><a href="#7-Serviceï¼ˆæœåŠ¡ï¼‰" class="headerlink" title="7. Serviceï¼ˆæœåŠ¡ï¼‰"></a>7. Serviceï¼ˆæœåŠ¡ï¼‰</h3><p>Service æ˜¯ä¸€ç§æŠ½è±¡æ¦‚å¿µï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ª Pod é€»è¾‘é›†åˆä»¥åŠè®¿é—®å®ƒä»¬çš„ç­–ç•¥ã€‚Service å¯ä»¥çœ‹ä½œä¸€ç»„æä¾›ç›¸åŒæœåŠ¡çš„ Pod çš„å¯¹å¤–è®¿é—®æ¥å£ï¼Œ å³ Pod ç»„æˆçš„é›†ç¾¤ã€‚åœ¨å—åˆ° RC è°ƒæ§çš„æ—¶å€™ï¼ŒPodå‰¯æœ¬æ˜¯å˜åŒ–çš„ï¼Œå¯¹åº”çš„è™šæ‹Ÿ IP ä¹Ÿæ˜¯å˜åŒ–çš„ï¼Œä½† Service çš„ Cluster IP åœ°å€æ˜¯ Kubernetes ç³»ç»Ÿä¸­çš„è™šæ‹ŸIPåœ°å€(è™šæ‹ŸIPçš„èŒƒå›´é€šè¿‡k8s API Serverçš„å¯åŠ¨å‚æ•° â€“service-cluster-ip-range=19.254.0.0/16é…ç½®)ï¼Œç”±ç³»ç»ŸåŠ¨æ€åˆ†é…ï¼Œåœ¨é”€æ¯è¯¥ Service ä¹‹å‰ï¼Œè¿™ä¸ª IP åœ°å€éƒ½ä¸ä¼šå†å˜åŒ–äº†ã€‚<br>è¿™æ ·ï¼Œ Serviceå°±å¯ä»¥ä½œä¸º Pod çš„è®¿é—®å…¥å£ï¼Œèµ·åˆ°ä»£ç†æœåŠ¡å™¨çš„ä½œç”¨ï¼ˆåŒæ—¶å¯ä»¥ä»£ç† k8s å¤–éƒ¨çš„æœåŠ¡ï¼‰ï¼Œè€Œå¯¹äºè®¿é—®è€…æ¥è¯´ï¼Œé€šè¿‡Serviceè¿›è¡Œè®¿é—®ï¼Œæ— éœ€ç›´æ¥æ„ŸçŸ¥ Podã€‚<br></p>
<blockquote>
<p>è™šæ‹Ÿ IP å±äº k8s å†…éƒ¨çš„è™šæ‹Ÿç½‘ç»œï¼Œå¤–éƒ¨æ˜¯å¯»å€ä¸åˆ°çš„ã€‚åœ¨ k8s ç³»ç»Ÿä¸­ï¼Œå®é™…ä¸Šæ˜¯ç”± k8s Proxyç»„ä»¶è´Ÿè´£å®ç°è™šæ‹Ÿ IP è·¯ç”±å’Œè½¬å‘çš„ï¼Œæ‰€ä»¥k8s Nodeä¸­éƒ½å¿…é¡»è¿è¡Œäº†k8s Proxyï¼Œä»è€Œåœ¨å®¹å™¨è¦†ç›–ç½‘ç»œä¹‹ä¸Šåˆå®ç°äº†k8så±‚çº§çš„è™šæ‹Ÿè½¬å‘ç½‘ç»œã€‚<br><br>å°†æœåŠ¡å‘å¸ƒè‡³å¤–éƒ¨ç½‘ç»œè®¿é—®<a href="http://alesnosek.com/blog/2017/02/14/accessing-kubernetes-pods-from-outside-of-the-cluster/" target="_blank" rel="noopener">æ–¹å¼</a><br></p>
</blockquote>
<p>ç”±äº pod ä¼šéšæ—¶é”€æ¯é‡å»ºï¼Œ æ‰€ä»¥ k8s ä¼šæ ¹æ® Service å…³è”åˆ° Pod çš„ PodIP ä¿¡æ¯ç»„åˆæˆä¸€ä¸ª Endpointsï¼Œç”¨æ¥ç›¸äº’è¡”æ¥ï¼Œ å¹¶ä¸” Endpoints ä¼šéšç€ pod çš„å˜åŒ–è€Œå˜åŒ–</p>
<h3 id="8-Volumeï¼ˆå­˜å‚¨å·ï¼‰"><a href="#8-Volumeï¼ˆå­˜å‚¨å·ï¼‰" class="headerlink" title="8. Volumeï¼ˆå­˜å‚¨å·ï¼‰"></a>8. Volumeï¼ˆå­˜å‚¨å·ï¼‰</h3><p>k8s çš„ Volume æ¦‚å¿µä¸ Docker çš„ Volume æ¯”è¾ƒç±»ä¼¼ï¼Œä½†ä¸å®Œå…¨ç›¸åŒï¼Œ æœ‰<code>æœ¬åœ°</code>ã€<code>ç½‘ç»œ</code>ã€<code>ä¿¡æ¯</code>ç­‰å‡ ç§ç±»å‹çš„æ•°æ®å·ã€‚</p>
<h3 id="9-ç®€å•åˆ›å»ºèµ„æºæµç¨‹"><a href="#9-ç®€å•åˆ›å»ºèµ„æºæµç¨‹" class="headerlink" title="9. ç®€å•åˆ›å»ºèµ„æºæµç¨‹"></a>9. ç®€å•åˆ›å»ºèµ„æºæµç¨‹</h3><p>å‡è®¾æœ‰ <code>Deployment</code> å®šä¹‰æ–‡ä»¶ <code>deployment-demo.yaml</code> å’Œ <code>Service</code> å®šä¹‰æ–‡ä»¶ <code>service-demo.yaml</code><br><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ kubectl create deployment-demo.yaml # åˆ›å»ºæ§åˆ¶å™¨å’Œ Pod</span><br><span class="line">$ kubectl create service-demo.yaml    # åˆ›å»º<span class="built_in"> service </span>å’Œ endpoints</span><br><span class="line">$ kubectl <span class="builtin-name">get</span> all                     # æŸ¥çœ‹æ‰€æœ‰èµ„æºä¿¡æ¯</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>å‚è€ƒï¼š <br><br><a href="https://www.jianshu.com/p/63ffc2214788" target="_blank" rel="noopener">kuberneteså…¥é—¨</a><br><br><a href="https://www.cnblogs.com/zhenyuyaodidiao/p/6500720.html" target="_blank" rel="noopener">Kubernetesæ ¸å¿ƒæ¦‚å¿µæ€»ç»“</a><br><br><a href="https://kubernetes.io/docs/concepts/" target="_blank" rel="noopener">k8s æ¦‚å¿µ</a><br><br><a href="http://alesnosek.com/blog/2017/02/14/accessing-kubernetes-pods-from-outside-of-the-cluster/" target="_blank" rel="noopener">Accessing Kubernetes Pods from Outside of the Cluster</a></p>
</blockquote>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
      </tags>
  </entry>
  <entry>
    <title>å¾®ä¿¡å°ç¨‹åºå¼€å‘å·¥å…· linux è¿è¡Œ</title>
    <url>/2018/01/14/wechat_game/prepare/</url>
    <content><![CDATA[<p>é¦–å…ˆï¼Œå¾®ä¿¡å°ç¨‹åºå¼€å‘å·¥å…·æ˜¯ç”¨nw.jså®ç°çš„ï¼Œ<a href="https://nwjs.io/" target="_blank" rel="noopener">nw.js</a>(ç›´æ¥ä»DOMä¸­è°ƒç”¨æ‰€æœ‰çš„Node.jsæ¨¡å—)<br>æœ¬èº«æ˜¯è·¨å¹³å°çš„ï¼Œä½†æ˜¯å¾®ä¿¡åªå‡ºäº†å¼€å‘å·¥å…·çš„windowså’Œmacç‰ˆã€‚<br>ä¸‹é¢ä»‹ç» linux ç³»ç»Ÿå¦‚ä½•è¿è¡Œå¼€å‘å·¥å…·ï¼Œ ä»¥ ubuntu ä¸ºä¾‹ã€‚<br><a id="more"></a></p>
<h3 id="1-nw"><a href="#1-nw" class="headerlink" title="1.nw"></a>1.nw</h3><p>ä¸‹è½½nwjs sdkï¼ˆéœ€è¦devtoolçš„æ”¯æ´ï¼‰ å‹ç¼©åŒ…ä¹‹åè§£å‹;</p>
<h3 id="2-è®¾ç½®-path-å˜é‡ï¼›"><a href="#2-è®¾ç½®-path-å˜é‡ï¼›" class="headerlink" title="2.è®¾ç½® path å˜é‡ï¼›"></a>2.è®¾ç½® path å˜é‡ï¼›</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim ~/.bashrc <span class="comment"># è§†ä¸ªäººæƒ…å†µé€‰æ‹©æ–‡ä»¶</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åŠ å…¥æ­¥éª¤ä¸€ä¸­è§£å‹ç›®å½•ï¼Œ </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚ï¼š <span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$PATH</span>:/home/kk/Downloads/nwjs-sdk-v0.27.4-linux-x64"</span></span></span><br></pre></td></tr></table></figure>
<h3 id="3-package-nw"><a href="#3-package-nw" class="headerlink" title="3.package.nw"></a>3.package.nw</h3><p>åœ¨ windows æœºå™¨å®‰è£…å¼€å‘å·¥å…·ï¼Œ æ‰¾åˆ°å®‰è£…ç›®å½•ï¼Œå°† package.nw æ–‡ä»¶å¤¹æ‹·å…¥ ubuntu ç³»ç»Ÿï¼›</p>
<h3 id="4-è¿è¡Œ"><a href="#4-è¿è¡Œ" class="headerlink" title="4.è¿è¡Œ"></a>4.è¿è¡Œ</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> package.nw</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nw .</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>wechat</category>
      </categories>
      <tags>
        <tag>wechat_game</tag>
      </tags>
  </entry>
  <entry>
    <title>Scrapy-å…¥é—¨æ•™ç¨‹</title>
    <url>/2017/12/23/web-spider/scrapy-%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<p>Scrapyæ˜¯ä¸€ä¸ªä¸ºäº†çˆ¬å–ç½‘ç«™æ•°æ®ï¼Œæå–ç»“æ„æ€§æ•°æ®è€Œç¼–å†™çš„åº”ç”¨æ¡†æ¶ã€‚ å¯ä»¥åº”ç”¨åœ¨åŒ…æ‹¬æ•°æ®æŒ–æ˜ï¼Œä¿¡æ¯å¤„ç†æˆ–å­˜å‚¨å†å²æ•°æ®ç­‰ä¸€ç³»åˆ—çš„ç¨‹åºä¸­ã€‚<br>æœ¬ç³»åˆ—æ‰€æœ‰æ–‡æ¡£å‡å·²åŸºäº linux æ“ä½œç³»ç»Ÿ<br><a id="more"></a></p>
<h3 id="1-å®‰è£…"><a href="#1-å®‰è£…" class="headerlink" title="1. å®‰è£…"></a>1. å®‰è£…</h3><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">$ pip <span class="keyword">install</span> Scrapy</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>scrapy</category>
      </categories>
      <tags>
        <tag>scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Debezium ä»‹ç»</title>
    <url>/2020/05/28/debezium/simple-intro/</url>
    <content><![CDATA[<ul>
<li>åˆ†å¸ƒå¼ CDC æœåŠ¡</li>
<li>ç”Ÿæˆæ•°æ®åº“è¡Œçº§å˜åŒ–äº‹ä»¶æµçš„åˆ†å¸ƒå¼å¹³å°</li>
<li>åŸºäº kafka connect</li>
<li>ä½äº kafka å’Œ å…¶ä»–æ•°æ®ç³»ç»Ÿä¹‹é—´çš„æ•°æ®å·¥å…·, å†…ç½® producer å’Œ consumer æ¥å£, æä¾›æ’ä»¶æ¨¡å¼(ä¾›ä½¿ç”¨è€…è‡ªå®šä¹‰å¼€å‘ connectorã€converterç­‰, å°†æ•°æ®å¯¼å…¥å¯¼å‡º kafkaã€æ ¼å¼åŒ–ç­‰)</li>
</ul>
<blockquote>
<p>é¡¹ç›®å¾ˆå¥½, é—®é¢˜ä¿®å¤éå¸¸åŠæ—¶<br>å¤§ä½“æ„æˆ: debezium( connector( task))</p>
</blockquote>
<a id="more"></a>
<blockquote>
<p>kafka connect çš„ CDC æ¶æ„å¦‚ä¸‹</p>
</blockquote>
<p><img src="https://personal-1258258052.cos.ap-shanghai.myqcloud.com/debezium/debezium_arch.png" alt="åŸºäº kafka connect çš„ CDC æµè½¬"></p>
<blockquote>
<p>debezium å°±æ˜¯å¯¹ kafka connect è¿›è¡ŒåŒ…è£…, å¹¶å®ç°äº†ä¸Šå›¾è¯»å–æ•°æ®åº“å˜æ›´éƒ¨åˆ†<br>æ‰€ä»¥, å»ºè®®å…ˆäº†è§£ <a href="https://docs.confluent.io/current/connect/index.html" target="_blank" rel="noopener">kafka connect</a>, é»˜è®¤å·²æœ‰æ‰€äº†è§£</p>
</blockquote>
<h2 id="1-æ„æˆ"><a href="#1-æ„æˆ" class="headerlink" title="1. æ„æˆ"></a>1. æ„æˆ</h2><ul>
<li>debezium é›†ç¾¤<ul>
<li>æ²¡æœ‰ä»”ç»†ç ”ç©¶, å†…ç½® leader é€‰ä¸¾ç®—æ³•, ä¸éœ€è¦è¿‡å¤šå…³æ³¨</li>
<li>connector<ul>
<li>åŠŸèƒ½ä¸Šæ˜¯ CDC çš„åŠŸèƒ½å®ç° (debezium æ¨å‡ºäº†å¤šç§æ•°æ®åº“çš„ connector å®ç°)</li>
<li>æ¶æ„ä¸Šæ˜¯ CDC ä»»åŠ¡çš„ç®¡ç†è€…</li>
</ul>
</li>
<li>task<ul>
<li>CDC çš„æ‰§è¡Œè€…</li>
</ul>
</li>
</ul>
</li>
<li>kafka é›†ç¾¤<ul>
<li>å­˜å‚¨ debezium çš„ä¸€ç³»åˆ—ä¿¡æ¯<ul>
<li>config topic: connctor é…ç½®ä¿¡æ¯</li>
<li>status topic: connectorã€task çš„è¿è¡ŒçŠ¶æ€</li>
<li>offset topic: cdc å¯¹äºæ•°æ®åº“çš„ offset ä¿¡æ¯ (æ¯”å¦‚ mysql binlog çš„ pos gtid ç­‰)</li>
</ul>
</li>
<li>CDC æ•°æ®<ul>
<li>å†…ç½® kafka çš„ sink, ç›´æ¥è½åœ° kafka, ä¸ºåç»­çš„æ“ä½œæä¾›æ–¹ä¾¿</li>
<li>è¡¨å’Œ topic ä¸€å¯¹ä¸€</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-åŠŸèƒ½ç‰¹ç‚¹"><a href="#2-åŠŸèƒ½ç‰¹ç‚¹" class="headerlink" title="2. åŠŸèƒ½ç‰¹ç‚¹"></a>2. åŠŸèƒ½ç‰¹ç‚¹</h2><ul>
<li>ä¿è¯æ•è·æ‰€æœ‰å˜æ›´<ul>
<li>ä»¥ binlog row æ¨¡å¼ä¸ºä¾‹, åªè¦ binlog ä¸ä¸¢, å°±å¯ä»¥ä¿è¯æ•è·æ‰€æœ‰å˜æ›´</li>
</ul>
</li>
<li>ä½å»¶è¿Ÿ</li>
<li>Snapshots<ul>
<li>å·²æœ‰æ•°æ®çš„ snapshot</li>
<li>ä¸ªäººå»ºè®®ä¸è¦ç†ä¼šè¿™ä¸ª, æ„Ÿè§‰è¿™åŠŸèƒ½æ”¾åœ¨ CDC ä¸­ä¸å¤ªåˆé€‚</li>
</ul>
</li>
<li>Filters<ul>
<li>è‡ªå®šä¹‰ db table column çš„è¿‡æ»¤</li>
</ul>
</li>
<li>æœåŠ¡æ€§èƒ½ç›‘æ§<ul>
<li>JMX, è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„</li>
</ul>
</li>
<li>æ¶ˆæ¯è½¬æ¢<ul>
<li>æ²¡äº†è§£è¿‡å•Š, æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¯•è¯•</li>
</ul>
</li>
</ul>
<h2 id="3-ä¸»è¦åŸç†"><a href="#3-ä¸»è¦åŸç†" class="headerlink" title="3. ä¸»è¦åŸç†"></a>3. ä¸»è¦åŸç†</h2><blockquote>
<p>ç®€å•çš„ä»‹ç»ä¸€ä¸‹ debezium çš„ CDC æ˜¯æ€ä¹ˆåšçš„:<br>åŸºäºæ•°æ®åº“æœ¬èº«çš„é€»è¾‘è®°å½•å’Œå¤‡ä»½æœºåˆ¶æ¥å®ç°çš„</p>
</blockquote>
<p>ä¸¾å‡ ä¸ªä¾‹å­</p>
<ul>
<li>Mysql<ul>
<li>binlog(row)</li>
</ul>
</li>
<li>pg<ul>
<li>wal(logic)</li>
<li>Replication Slot</li>
</ul>
</li>
<li>mongodb<ul>
<li>oplog</li>
</ul>
</li>
</ul>
<blockquote>
<p>æ‰€ä»¥, å°±æ˜¯é€»è¾‘é‡æ”¾</p>
</blockquote>
<h2 id="4-æ•°æ®åº“æ”¯æŒ"><a href="#4-æ•°æ®åº“æ”¯æŒ" class="headerlink" title="4. æ•°æ®åº“æ”¯æŒ"></a>4. æ•°æ®åº“æ”¯æŒ</h2><blockquote>
<p>æä¾›äº†å¤šç§æ•°æ®åº“çš„æ”¯æŒ</p>
</blockquote>
<ul>
<li>Mysql</li>
<li>MongoDB</li>
<li>PostgreSql</li>
<li>Oracle</li>
<li>Sql Server</li>
<li>Db2</li>
<li>Cassandra</li>
</ul>
<h2 id="5-Demo"><a href="#5-Demo" class="headerlink" title="5. Demo"></a>5. Demo</h2><p><a href="https://debezium.io/documentation/reference/1.1/tutorial.html" target="_blank" rel="noopener">Debezium å®˜ç½‘</a></p>
]]></content>
      <categories>
        <category>Debezium</category>
      </categories>
      <tags>
        <tag>Debezium</tag>
      </tags>
  </entry>
</search>
