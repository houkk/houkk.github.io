(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{374:function(t,s,e){"use strict";e.r(s);var a=e(18),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("基于 pg 的逻辑复制功能, 需要 wal(logic) 和 逻辑解码输出插件的辅助, 实现数据变更事件通知")])]),t._v(" "),e("h2",{attrs:{id:"_1-postgresql-配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-postgresql-配置"}},[t._v("#")]),t._v(" 1. PostgreSql 配置")]),t._v(" "),e("ul",[e("li",[e("ol",[e("li",[t._v("版本: 9.6 or later (10.0 以上最好)")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"2"}},[e("li",[t._v("wal (write-ahead logs 预写日志)")])]),t._v(" "),e("ul",[e("li",[e("code",[t._v("xlog")]),t._v(": pg 9.x 的 wal 叫做 xlog")]),t._v(" "),e("li",[t._v("lsn(localtion 9.x): lsn 日志号, 标记 wal 文件以及文件内偏移量\n"),e("ul",[e("li",[t._v("32位/32位")]),t._v(" "),e("li",[t._v('左边 32 位，通过计算获得 wal 日志的文件名: "timeline + lsn计算"')]),t._v(" "),e("li",[t._v("右边 32 位，获得偏移量")])])]),t._v(" "),e("li",[t._v("逻辑解码")]),t._v(" "),e("li",[t._v("output plugins")]),t._v(" "),e("li",[t._v("replication slots")]),t._v(" "),e("li",[t._v("wal_level: logic\n"),e("ul",[e("li",[t._v("wal 日志中加入信息支持逻辑解码, 增大 wal 日志, 尤其是 update、delete")]),t._v(" "),e("li",[t._v("不支持 DDL、列存、压缩表的解码, 需要额外触发器处理 DDL, 可以做到表级订阅")])])]),t._v(" "),e("li",[t._v("不使用的 replication slots 要及时删除\n"),e("ul",[e("li",[t._v("replication slots 存在即保证从库宕机后, 主库不会删除从库上报的 lsn 之后的 wal")]),t._v(" "),e("li",[t._v("connector 的 上报 lsn 不变化, 造成 xlog 堆积, 影响磁盘空间")])])])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"3"}},[e("li",[t._v("逻辑解码输出插件")])]),t._v(" "),e("ul",[e("li",[t._v("解码并输出")]),t._v(" "),e("li",[t._v("pgoutput, 10+ 预装了")]),t._v(" "),e("li",[t._v("wal2json, 基于 json, 由 wal2json 社区维护, 需要预装")]),t._v(" "),e("li",[t._v("decoderbufs, 基于 protobuf, 由 debezium 社区维护，需要预装")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"4"}},[e("li",[t._v("数据库设置")])]),t._v(" "),e("ul",[e("li",[e("ol",[e("li",[t._v("wal_level: logical")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"2"}},[e("li",[t._v("max_replication_slots >= 1")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"3"}},[e("li",[t._v("权限")])]),t._v(" "),e("ul",[e("li",[t._v("REPLICATION")]),t._v(" "),e("li",[t._v("LOGIN")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"4"}},[e("li",[t._v("postgresql.conf")])]),t._v(" "),e("ul",[e("li",[t._v("shared_preload_libraries = 'decoderbufs,wal2json' (预装插件配置)")]),t._v(" "),e("li",[t._v("wal_level = logical")]),t._v(" "),e("li",[t._v("max_wal_senders = 1")]),t._v(" "),e("li",[t._v("max_replication_slots = 1")])])])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"5"}},[e("li",[t._v("表设置")])]),t._v(" "),e("ul",[e("li",[e("ol",[e("li",[t._v("REPLICA IDENTITY (副本身份, 决定了在 kafka message 中 update 和 delete 事件 的 before 内容)")])]),t._v(" "),e("ul",[e("li",[t._v("DEFAULT: 仅显示主键")]),t._v(" "),e("li",[t._v("NOTHING: nothing")]),t._v(" "),e("li",[t._v("FULL: 全部信息")]),t._v(" "),e("li",[t._v("INDEX: 索引信息")]),t._v(" "),e("li",[t._v("查看 sql:")])])])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"6"}},[e("li",[t._v("数据库字符集")])]),t._v(" "),e("ul",[e("li",[t._v("仅支持 UTF-8 字符集\n"),e("ul",[e("li",[t._v("connector 无法处理 单字节字符集中的 包含扩展 ASCII 码字符集的字符串 ("),e("code",[t._v("TODO")]),t._v(": 不太理解, 后续跟进)")]),t._v(" "),e("li",[t._v("Debezium currently supports only database with UTF-8 character encoding. With a single byte character encoding it is not possible to correctly process strings containing extended ASCII code characters.")])])])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"7"}},[e("li",[t._v("常用命令合集")])])])]),t._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// superuser 创建 publication, 使用 pgoutput 时需要事先创建")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" PUBLICATION ${name} "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOR")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ALL")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLES")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// publication")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" pg_publication"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// show publication tables")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" pg_publication_tables"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 复制插槽 列表")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" pg_replication_slots"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// wal 等级")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("show")]),t._v(" wal_level"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 新安装插件")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SHOW")]),t._v(" shared_preload_libraries"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 查看 REPLICA IDENTITY")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" relreplident\n\t\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("when")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'d'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'default'")]),t._v("\n\t\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("when")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'n'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nothing'")]),t._v("\n\t\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("when")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'f'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'full'")]),t._v("\n\t\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("when")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'i'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'index'")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" replica_indentity"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\trelname\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" pg_class "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" relname "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("in")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'products'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'geom'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'orders'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'customers'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修改 REPLICA IDENTITY")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("alter")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("table")]),t._v(" test_debezium_1 replica "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("IDENTITY")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("full")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br"),e("span",{staticClass:"line-number"},[t._v("24")]),e("br"),e("span",{staticClass:"line-number"},[t._v("25")]),e("br"),e("span",{staticClass:"line-number"},[t._v("26")]),e("br"),e("span",{staticClass:"line-number"},[t._v("27")]),e("br"),e("span",{staticClass:"line-number"},[t._v("28")]),e("br"),e("span",{staticClass:"line-number"},[t._v("29")]),e("br"),e("span",{staticClass:"line-number"},[t._v("30")]),e("br"),e("span",{staticClass:"line-number"},[t._v("31")]),e("br")])]),e("h3",{attrs:{id:"_1-1-各平台配置流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-各平台配置流程"}},[t._v("#")]),t._v(" 1.1 各平台配置流程")]),t._v(" "),e("ul",[e("li",[t._v("heroku 无法安装插件, 只能使用 pg 10+ 自带的逻辑解码")]),t._v(" "),e("li",[t._v("Amazon RDS\n"),e("ul",[e("li",[e("ol",[e("li",[t._v("rds.logical_replication: 1 ("),e("code",[t._v("TODO:")]),t._v(" 此参数的修改意义, 貌似是开关)")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"2"}},[e("li",[t._v("wal_level: logical; 此参数无法修改, 步骤一修改后自动生效(或需重启)")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"3"}},[e("li",[t._v("plugin.name 修改")])]),t._v(" "),e("ul",[e("li",[t._v("10+ 默认 pgoutput")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"4"}},[e("li",[t._v("版本限制: wal2json 版本太低, 类型约束信息不完整")])]),t._v(" "),e("ul",[e("li",[t._v("Postgres 9.6: 9.6.10 and newer")]),t._v(" "),e("li",[t._v("Postgres 10: 10.5 and newer")]),t._v(" "),e("li",[t._v("Postgres 11: any version")])])])])])]),t._v(" "),e("h2",{attrs:{id:"_2-connector"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-connector"}},[t._v("#")]),t._v(" 2. connector")]),t._v(" "),e("h3",{attrs:{id:"_2-1-逻辑解码插件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-逻辑解码插件"}},[t._v("#")]),t._v(" 2.1 逻辑解码插件")]),t._v(" "),e("blockquote",[e("p",[t._v("需要安装在 postgresql server 中, 用作解码 wal 为可读 (创建 replication slot 时亦会使用）")])]),t._v(" "),e("blockquote",[e("p",[e("a",{attrs:{href:"https://debezium.io/documentation/reference/0.10/postgres-plugins.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("细节"),e("OutboundLink")],1)])]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://github.com/debezium/postgres-decoderbufs",target:"_blank",rel:"noopener noreferrer"}},[t._v("decoderbufs"),e("OutboundLink")],1),t._v(" "),e("ul",[e("li",[t._v("Debezium 社区维护, 基于 ProtoBuf")])])]),t._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/eulerto/wal2json",target:"_blank",rel:"noopener noreferrer"}},[t._v("wal2json"),e("OutboundLink")],1),t._v(" "),e("ul",[e("li",[t._v("wal2json 社区维护, 基于 json")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://debezium.io/documentation/reference/0.10/connectors/postgresql.html#discrepance-between-plugins",target:"_blank",rel:"noopener noreferrer"}},[t._v("一堆问题, 乱七八糟的"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[t._v("pgoutput\n"),e("ul",[e("li",[t._v("postgresql 10+ 自带 (Debezium 0.10 可用)")]),t._v(" "),e("li",[t._v("满足条件的话，直接使用这个; (其余是 pg 10 之前的版本使用)")])])])]),t._v(" "),e("h3",{attrs:{id:"_2-2-connector"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-connector"}},[t._v("#")]),t._v(" 2.2 Connector")]),t._v(" "),e("blockquote",[e("p",[t._v("注意事项")])]),t._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),e("ul",[e("li",[t._v("connector 依赖于 pg 的逻辑解码功能, 所以:\n"),e("ul",[e("li",[e("code",[t._v("无法监控 DDL 变化")])]),t._v(" "),e("li",[t._v("逻辑解码器原因, connector 只能监控集群中"),e("code",[t._v("主服务器")]),t._v("变化\n"),e("ul",[e("li",[t._v("主服务宕机或被降级, connector 停止")]),t._v(" "),e("li",[t._v("如果此服务器会被恢复, 重启 connector 即可")]),t._v(" "),e("li",[t._v("如果其他服务器升级为主服务器， connector 重启前需要变更配置")])])])])]),t._v(" "),e("li",[t._v("主键更改有风险: "),e("a",{attrs:{href:"https://debezium.io/documentation/reference/0.10/connectors/postgresql.html#streaming-changes",target:"_blank",rel:"noopener noreferrer"}},[t._v("流式修改"),e("OutboundLink")],1),t._v(" -> Note (TODO: 搞清楚怎么回事)\n"),e("ul",[e("li",[t._v("貌似没什么影响\n"),e("ul",[e("li",[t._v("无主键的表, 数据没有 key, 不是为 null")]),t._v(" "),e("li",[t._v("将主键去除后(不是删列), 数据 key 仍为原来的 key 结构")])])])])]),t._v(" "),e("li",[t._v("当 replication slot 丢失时, 需要重启 task 来自动 initReplicationSlot")])])]),t._v(" "),e("h3",{attrs:{id:"_2-3-connector-工作流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-connector-工作流程"}},[t._v("#")]),t._v(" 2.3 connector 工作流程")]),t._v(" "),e("ul",[e("li",[t._v("snapshot\n"),e("ul",[e("li",[e("ol",[e("li",[t._v("设置事务隔离级别 SERIALIZABLE, READ ONLY, DEFERRABLE (DEFERRABLE 保证了长时间执行时不与其他串行事务冲突)")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"2"}},[e("li",[t._v("对每张表加锁 SHARE UPDATE EXCLUSIVE MODE (锁有点乱, TODO: 整理并详解), 确保表结构不被更改")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"3"}},[e("li",[t._v("获取当前事务开始时 wal(lsn) 位置, 为了在 snaphsot 后从该位置开始监控数据, 防止数据遗漏")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"4"}},[e("li",[t._v("获取 schema, 如果开启数据同步, 同时会为每行现有数据生成 read 事件, 同步至 kafka 对应 topic")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"5"}},[e("li",[t._v("commit")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"6"}},[e("li",[t._v("记录快照完成 offset (? 和 步骤 3 的关系 ? 为了 snapshot 未完成时意外重启重新开始)")])])])])]),t._v(" "),e("li",[t._v("Streaming Changes\n"),e("ul",[e("li",[t._v("initReplicationSlot (replication slot, 没有则创建, 判断是否被其他进程占用)")]),t._v(" "),e("li",[t._v("initPublication (pgoutput 插件需要 "),e("code",[t._v("publication")]),t._v(" 来进行限定表白名单, 没有则创建 all tables)\n"),e("ul",[e("li",[t._v("可以事先用 superuser 创建, connector 默认 publication 为 "),e("code",[t._v("dbz_publication")])])])]),t._v(" "),e("li",[t._v("从上述步骤 3 中获取到的 LSNs (Log Sequence Numbers) 开始")])])])]),t._v(" "),e("h3",{attrs:{id:"_2-4-类型转换"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-类型转换"}},[t._v("#")]),t._v(" 2.4 类型转换")]),t._v(" "),e("blockquote",[e("p",[t._v("大体类型转换和 mysql 类似, 下面列出特殊点")])]),t._v(" "),e("ul",[e("li",[t._v('HSTORE => String (\'"a" => "b"\' => "{"a": "b"}")')]),t._v(" "),e("li",[t._v("网络地址类型\n"),e("ul",[e("li",[t._v("INET、CIDR、MACADDR、MACADDR8 => String")])])]),t._v(" "),e("li",[t._v("PostGIS Types (空间类型转化) (待续... 有空再说)")]),t._v(" "),e("li",[t._v("Toasted: (存储内容超过 8 kb, 采用 Toasted 存储, 具体再说吧)")])]),t._v(" "),e("h3",{attrs:{id:"_2-5-部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-部署"}},[t._v("#")]),t._v(" 2.5 部署")]),t._v(" "),e("ul",[e("li",[e("ol",[e("li",[t._v("安装逻辑解码插件 (decoderbufs、wal2json ...)")])]),t._v(" "),e("ul",[e("li",[t._v("pg 10+ 默认安装 pgoutput, 推荐使用 (pgoutput 需要 superuser 权限创建 publication, 或者事先创建)")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"2"}},[e("li",[t._v("配置 pg 支持逻辑复制 (见第一大项)")])])]),t._v(" "),e("li",[e("ol",{attrs:{start:"3"}},[e("li",[t._v("POST 创建 connector")])]),t._v(" "),e("ul",[e("li",[e("code",[t._v("name")]),t._v(": '' (connector 名称, 唯一性)")]),t._v(" "),e("li",[e("code",[t._v("config")]),t._v(":\n"),e("ul",[e("li",[e("code",[t._v("connector.class")]),t._v(': "io.debezium.connector.postgresql.PostgresConnector"')]),t._v(" "),e("li",[e("code",[t._v("tasks.max")]),t._v(": 1")]),t._v(" "),e("li",[e("code",[t._v("plugin.name")]),t._v(": 见步骤一")]),t._v(" "),e("li",[e("code",[t._v("slot.name")]),t._v(": 逻辑解码槽, 保证 wal 不被清理, 所以, 要特别注意 (和 connector 一对一)")]),t._v(" "),e("li",[e("code",[t._v("publication")]),t._v(": 存在默认值, dbz_publication;\n"),e("ul",[e("li",[t._v("使用 pgoutput 时, 需创建;")]),t._v(" "),e("li",[t._v("需要使用 supuser 创建, 由于目前功能缺陷, 可以事先创建 all tables 的 publication")])])]),t._v(" "),e("li",[e("code",[t._v("slot.drop_on_stop")]),t._v(": true or false\n"),e("ul",[e("li",[t._v("connector 停止后 (stop 实例 ?), 是否删除 replication slot")]),t._v(" "),e("li",[t._v("推荐测试环境设置为 true, 防止 wal 大量堆积, 占用磁盘空间")]),t._v(" "),e("li",[t._v("生产环境设置为 false, 但一定要有 connector 宕机的处理预案以及磁盘空间预估, 不然准备迎接磁盘"),e("code",[t._v("爆满")]),t._v("吧")]),t._v(" "),e("li",[e("strong",[e("em",[e("code",[t._v("注意")])])]),t._v(" : 当为 true 时, connector 重启会删除、重建 slot, 会导致"),e("code",[t._v("数据丢失")])])])]),t._v(" "),e("li",[e("code",[t._v("database.hostname")])]),t._v(" "),e("li",[e("code",[t._v("database.port")])]),t._v(" "),e("li",[e("code",[t._v("database.user")])]),t._v(" "),e("li",[e("code",[t._v("database.password")])]),t._v(" "),e("li",[e("code",[t._v("database.dbname")]),t._v(": 库名")]),t._v(" "),e("li",[e("code",[t._v("database.server.name")]),t._v(": 服务名, 唯一性\n"),e("ul",[e("li",[t._v("topic name: "),e("code",[t._v("${database.server.name}.${schema name}.${table name}")])])])]),t._v(" "),e("li",[e("code",[t._v("schema.whitelis")]),t._v("t / "),e("code",[t._v("blacklist")])]),t._v(" "),e("li",[e("code",[t._v("table.whitelist")]),t._v(" / "),e("code",[t._v("blacklist")])]),t._v(" "),e("li",[e("code",[t._v("column.blacklist")]),t._v(": schemaName.tableName.columnName")]),t._v(" "),e("li",[e("code",[t._v("decimal.handling.mode")]),t._v(': "string" (Decimal 以 string 形式存在)')]),t._v(" "),e("li",[e("code",[t._v("tombstones.on.delete")]),t._v(": true or false (kafka 墓碑事件)")]),t._v(" "),e("li",[e("code",[t._v("snapshot.mode")]),t._v(":\n"),e("ul",[e("li",[e("code",[t._v("initial")]),t._v("(default): 仅在 connector 创建时执行快照")]),t._v(" "),e("li",[e("code",[t._v("always")]),t._v(": connector "),e("code",[t._v("每次启动")]),t._v("时执行快照")]),t._v(" "),e("li",[e("code",[t._v("never")]),t._v(": 字面意思")]),t._v(" "),e("li",[e("code",[t._v("initial_only")]),t._v(": 只执行快照, 后续的数据变化流不做处理")]),t._v(" "),e("li",[e("code",[t._v("exported")]),t._v(": 从 replication slot 创建的时间节点开始执行, 无锁")]),t._v(" "),e("li",[e("code",[t._v("custom")]),t._v(": 自己写代码, 同时需要制定 "),e("code",[t._v("snapshot.custom.class")])])])]),t._v(" "),e("li",[e("code",[t._v("snapshot.lock.timeout.ms")]),t._v(": 10000 (获取表锁超时时间)")])])])])])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('{\n    "name": "pg_inventory_1",\n    "config": {\n\t    "connector.class": "io.debezium.connector.postgresql.PostgresConnector",\n\t    "database.user": "postgres",\n\t    "database.dbname": "postgres",\n\t    "slot.name": "pg_inventory_1",\n\t    "database.server.name": "pg_inventory_1",\n\t    "database.port": "5432",\n\t    "plugin.name": "pgoutput",\n\t    "schema.whitelist": "inventory",\n\t    "table.whitelist": "inventory.orders",\n\t    "slot.drop_on_stop": "true",\n\t    "decimal.handling.mode": "string",\n\t    "database.hostname": "192.168.4.21",\n\t    "database.password": "postgres",\n\t    "snapshot.mode": "never"\n\t}\n}\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br")])]),e("h2",{attrs:{id:"_3-问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-问题"}},[t._v("#")]),t._v(" 3. 问题")]),t._v(" "),e("ul",[e("li",[e("ol",[e("li",[t._v("更新配置时, 报错, 且出现数据丢失")])]),t._v(" "),e("ul",[e("li",[t._v("复现步骤\n"),e("ul",[e("li",[t._v("一切正常后")]),t._v(" "),e("li",[t._v("没 200ms, update\\delete\\insert pg")]),t._v(" "),e("li",[t._v("kafka 数据正常")]),t._v(" "),e("li",[t._v("更新 table.whitelist")]),t._v(" "),e("li",[t._v("待更新完成后, 发现数据丢失")])])]),t._v(" "),e("li",[t._v("原因: slot.drop_on_stop: true 时, connector 重启, 则 slot 删除后重建, 造成数据丢失")])])])]),t._v(" "),e("p",[t._v("参考文档: "),e("br")]),t._v(" "),e("ol",[e("li",[e("a",{attrs:{href:"https://www.postgresql.org/docs/10/logical-replication.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("逻辑复制"),e("OutboundLink")],1),t._v(" "),e("br")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://juejin.im/entry/58ba3279570c350062124bc9",target:"_blank",rel:"noopener noreferrer"}},[t._v("pg 10.0 逻辑复制"),e("OutboundLink")],1),t._v(" "),e("br")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://jdbc.postgresql.org/documentation/head/replication.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("PG JDBC logical replication API"),e("OutboundLink")],1),t._v(" "),e("br")])])])}),[],!1,null,null,null);s.default=n.exports}}]);