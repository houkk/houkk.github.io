(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{360:function(s,n,a){"use strict";a.r(n);var t=a(25),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("依赖于 mongodb 的复制(副本集), 重放 oplog 实现数据变更行捕捉")])]),s._v(" "),a("h2",{attrs:{id:"_1-connector"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-connector"}},[s._v("#")]),s._v(" 1. connector")]),s._v(" "),a("ul",[a("li",[a("ol",[a("li",[s._v("依赖于 mongodb 的副本集, 利用 oplog 完成数据同步")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"2"}},[a("li",[s._v("读取副本集的 primary node, 根据副本集状态, 始终保持连接 primary node (所以确保副本集的注册 host 可以被外部访问)")])]),s._v(" "),a("ul",[a("li",[s._v("副本集模式下所有的副本地址(rs.add 的地址)必须保证 connector 可以访问")]),s._v(" "),a("li",[s._v("分片模式:\n"),a("ul",[a("li",[s._v("要保证 mongs host、mongos --configdb 配置的 config host、mongos 添加的分片 host (sh.addShard)、 config server 副本集 (rs.add 的 host)、shard 副本集（rs.add 的 host）全部可以被 connector 访问")]),s._v(" "),a("li",[s._v("要保证 config server、分片下拥有特殊权限用户\n"),a("ul",[a("li",[s._v("另外, 分片下用户无法通过 mongos 创建, 需要分别创建")])])])])])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"3"}},[a("li",[s._v("一个 collection 一个 topic, 和副本集、分片数无关")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"4"}},[a("li",[s._v("topic 分区方面")])]),s._v(" "),a("ul",[a("li",[s._v("可以确保同一 key 进入同一 topic, 即可以确保每个 document 操作的顺序性, 所以分区没什么影响")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"5"}},[a("li",[s._v("配置项")])]),s._v(" "),a("ul",[a("li",[a("ol",{attrs:{start:"0"}},[a("li",[s._v("mongodb.hosts (host:port)")])]),s._v(" "),a("ul",[a("li",[s._v("副本集模式: 主副本 host, 其实无所谓 (副本集的主副并不固定, 内部自行选举)")]),s._v(" "),a("li",[s._v("分片副本集: config server host")])])]),s._v(" "),a("li",[a("ol",[a("li",[s._v("指数规避配置 (暂时可以不予关注)")])]),s._v(" "),a("ul",[a("li",[s._v("connect.backoff.initial.delay.ms: 1s")]),s._v(" "),a("li",[s._v("connect.backoff.max.delay.ms: 120s")]),s._v(" "),a("li",[s._v("connect.max.attempts: 16")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"2"}},[a("li",[s._v("snapshot.mode")])]),s._v(" "),a("ul",[a("li",[s._v("connector 连接时是否进行数据备份")]),s._v(" "),a("li",[s._v("initial: 进行过往数据 copy")]),s._v(" "),a("li",[s._v("never: 只记录新数据")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"3"}},[a("li",[s._v("tasks.max")])]),s._v(" "),a("ul",[a("li",[s._v("默认 1")]),s._v(" "),a("li",[s._v("大于等于分片数")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"4"}},[a("li",[s._v("tombstones.on.delete")])]),s._v(" "),a("ul",[a("li",[s._v("墓碑事件")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"5"}},[a("li",[s._v("mongodb.user")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"6"}},[a("li",[s._v("mongodb.password")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"7"}},[a("li",[s._v("mongodb.name:")])]),s._v(" "),a("ul",[a("li",[s._v("类似 mysql/pg connector 的 database.server.name, 唯一、kafka topic 前缀")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"8"}},[a("li",[s._v("database.whitelist")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"9"}},[a("li",[s._v("collection.whitelist")])])])])]),s._v(" "),a("li",[s._v("注意事项:\n"),a("ul",[a("li",[s._v("命名规则\n"),a("ul",[a("li",[a("ol",[a("li",[s._v("服务名 /[a-z,A-Z,_][a-z,a-z,0-9,_]+/")])])]),s._v(" "),a("li")])])])])]),s._v(" "),a("blockquote",[a("p",[s._v("config demo")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{\n    "connector.class": "io.debezium.connector.mongodb.MongoDbConnector",\n\t  "mongodb.hosts": "192.168.4.23:27017",\n\t  "mongodb.name": "mongo_01",\n    "mongodb.user": "debezium",\n    "mongodb.password": "dbz",\n    "database.whitelist": "inventory",\n    "collection.whitelist": "inventory.customers,inventory.orders",\n    "snapshot.mode": "never",\n    "tasks.max": "1"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h2",{attrs:{id:"_2-database"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-database"}},[s._v("#")]),s._v(" 2. database")]),s._v(" "),a("ul",[a("li",[s._v("集群模式\n"),a("ul",[a("li",[s._v("分片模式和副本集模式(需要 oplog)")]),s._v(" "),a("li",[s._v("需要有权限读取 oplog 集合的账户")])])]),s._v(" "),a("li",[s._v("注意事项:\n"),a("ul",[a("li",[s._v("命名规则")]),s._v(" "),a("li",[s._v("副本集模式\n"),a("ul",[a("li",[s._v("内部权限 (keyfile)")]),s._v(" "),a("li",[s._v("保证 rs.add 的每个节点地址, connector 都可以访问")])])])])])]),s._v(" "),a("blockquote",[a("p",[s._v("特殊权限用户, 每个分片都需要(感觉这一点有点问题，太繁琐了，是用错了，还是怎么回事)")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    use admin;\n\n    db.runCommand({\n        createRole: "listDatabases",\n        privileges: [\n            { resource: { cluster : true }, actions: ["listDatabases"]}\n        ],\n        roles: []\n    });\n\n    db.createUser({\n        user: \'debezium\',\n        pwd: \'dbz\',\n        roles: [\n            { role: "readWrite", db: "inventory" }, // inventory 为监控库\n            { role: "read", db: "local" },\n            { role: "listDatabases", db: "admin" },\n            { role: "read", db: "config" },\n            { role: "read", db: "admin" }\n        ]\n    });\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h2",{attrs:{id:"_3-流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-流程"}},[s._v("#")]),s._v(" 3. 流程")]),s._v(" "),a("ul",[a("li",[s._v("Initial sync\n"),a("ul",[a("li",[s._v("初始化同步 oplog")])])]),s._v(" "),a("li",[s._v("Tailing the oplog\n"),a("ul",[a("li",[s._v("拥有 offset 后, 读取 oplog")])])])]),s._v(" "),a("h2",{attrs:{id:"_4-topic-payload-构成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-topic-payload-构成"}},[s._v("#")]),s._v(" 4. topic payload 构成")]),s._v(" "),a("ul",[a("li",[s._v("after: init 和 create 时的完整数据")]),s._v(" "),a("li",[s._v("patch: update 时的 sql")]),s._v(" "),a("li",[s._v("op:\n"),a("ul",[a("li",[s._v("r: snaphsot init")]),s._v(" "),a("li",[s._v("u: update")]),s._v(" "),a("li",[s._v("d: delete")]),s._v(" "),a("li",[s._v("c: create")])])])]),s._v(" "),a("h3",{attrs:{id:"_1-init-snapshot"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-init-snapshot"}},[s._v("#")]),s._v(" 1. init snapshot")]),s._v(" "),a("blockquote",[a("p",[s._v("operation: r")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('"payload": {\n    "after": "{\\"_id\\": {\\"$numberLong\\": \\"1001\\"},\\"first_name\\": \\"Sally12\\",\\"last_name\\": \\"Thomas\\",\\"email\\": \\"sally.thomas@acme.com\\"}",\n    "patch": null,\n    "source": {\n      "version": "0.10.0.Final",\n      "connector": "mongodb",\n      "name": "mongo_02",\n      "ts_ms": 1574235688000,\n      "snapshot": "true",\n      "db": "inventory",\n      "rs": "rs0",\n      "collection": "customers",\n      "ord": 1,\n      "h": 5175105543699020230\n    },\n    "op": "r",\n    "ts_ms": 1574235691071\n  }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h3",{attrs:{id:"_2-create"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-create"}},[s._v("#")]),s._v(" 2. create")]),s._v(" "),a("blockquote",[a("p",[s._v("operation: c")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('"payload": {\n    "after": "{\\"_id\\": {\\"$oid\\": \\"5dd4ef7e9e9939487b6c0239\\"},\\"first_name\\": 3.0,\\"last_name\\": 4.0,\\"email\\": 5.0}",\n    "patch": null,\n    "source": {\n      "version": "0.10.0.Final",\n      "connector": "mongodb",\n      "name": "mongo_02",\n      "ts_ms": 1574236030000,\n      "snapshot": "false",\n      "db": "inventory",\n      "rs": "rs0",\n      "collection": "customers",\n      "ord": 1,\n      "h": 131523180395089317\n    },\n    "op": "c",\n    "ts_ms": 1574236030371\n  }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h3",{attrs:{id:"_3-update"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-update"}},[s._v("#")]),s._v(" 3. update")]),s._v(" "),a("blockquote",[a("p",[s._v("operation: u")])]),s._v(" "),a("blockquote",[a("p",[s._v("patch: 显示 set 操作, 为了保证 oplog 操作的幂等性, 保证重复执行后的正确性")])]),s._v(" "),a("blockquote",[a("p",[s._v("注意: patch 内容由 mongodb 提供, 且 mongodb 各个版本之间的 patch 可能存在不同")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('  "payload": {\n    "after": null,\n    "patch": "{\\"$v\\": 1,\\"$set\\": {\\"last_name\\": 5.0}}",\n    "source": {\n      "version": "0.10.0.Final",\n      "connector": "mongodb",\n      "name": "mongo_02",\n      "ts_ms": 1574236075000,\n      "snapshot": "false",\n      "db": "inventory",\n      "rs": "rs0",\n      "collection": "customers",\n      "ord": 1,\n      "h": 5737963839219456046\n    },\n    "op": "u",\n    "ts_ms": 1574236075380\n  }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h3",{attrs:{id:"_4-delete"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-delete"}},[s._v("#")]),s._v(" 4. delete")]),s._v(" "),a("blockquote",[a("p",[s._v("operation: d")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('  "payload": {\n    "after": null,\n    "patch": null,\n    "source": {\n      "version": "0.10.0.Final",\n      "connector": "mongodb",\n      "name": "mongo_02",\n      "ts_ms": 1574237481000,\n      "snapshot": "false",\n      "db": "inventory",\n      "rs": "rs0",\n      "collection": "customers",\n      "ord": 1,\n      "h": -3225175849180220485\n    },\n    "op": "d",\n    "ts_ms": 1574237481422\n  }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);