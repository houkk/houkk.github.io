<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mysql Connector | kk</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/avatar-small.png">
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/assets/css/0.styles.c813989b.css" as="style"><link rel="preload" href="/assets/js/app.d9f093e5.js" as="script"><link rel="preload" href="/assets/js/2.09c698bd.js" as="script"><link rel="preload" href="/assets/js/8.7bd05949.js" as="script"><link rel="prefetch" href="/assets/js/10.5338b83b.js"><link rel="prefetch" href="/assets/js/11.b790cf62.js"><link rel="prefetch" href="/assets/js/12.4e29dc01.js"><link rel="prefetch" href="/assets/js/13.f6ff3c08.js"><link rel="prefetch" href="/assets/js/14.9fde3912.js"><link rel="prefetch" href="/assets/js/15.b4dfb18e.js"><link rel="prefetch" href="/assets/js/16.fbefe906.js"><link rel="prefetch" href="/assets/js/17.fd82246c.js"><link rel="prefetch" href="/assets/js/3.e710a6c2.js"><link rel="prefetch" href="/assets/js/4.c7e843a5.js"><link rel="prefetch" href="/assets/js/5.8be75361.js"><link rel="prefetch" href="/assets/js/6.a310b7ea.js"><link rel="prefetch" href="/assets/js/7.5ec747cf.js"><link rel="prefetch" href="/assets/js/9.3f3cfe78.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c813989b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar-small.png" alt="kk" class="logo"> <span class="site-name can-hide">kk</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node.js
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CDC" class="dropdown-title"><span class="title">CDC</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/debezium/" class="nav-link router-link-active">
  Debezium
</a></li></ul></div></div><div class="nav-item"><a href="/k8s/k8s-first.html" class="nav-link">
  k8s
</a></div><div class="nav-item"><a href="https://github.com/houkk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node.js
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CDC" class="dropdown-title"><span class="title">CDC</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/debezium/" class="nav-link router-link-active">
  Debezium
</a></li></ul></div></div><div class="nav-item"><a href="/k8s/k8s-first.html" class="nav-link">
  k8s
</a></div><div class="nav-item"><a href="https://github.com/houkk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/debezium/" aria-current="page" class="sidebar-link">Debezium 介绍</a></li><li><a href="/debezium/mysql.html" aria-current="page" class="active sidebar-link">Mysql Connector</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/debezium/mysql.html#_1-mysql-配置" class="sidebar-link">1. Mysql 配置</a></li><li class="sidebar-sub-header"><a href="/debezium/mysql.html#_2-connector-参数" class="sidebar-link">2. connector 参数</a></li><li class="sidebar-sub-header"><a href="/debezium/mysql.html#_3-启动流程" class="sidebar-link">3. 启动流程</a></li><li class="sidebar-sub-header"><a href="/debezium/mysql.html#_4-添加-table-whitelist" class="sidebar-link">4. 添加 table.whitelist</a></li></ul></li><li><a href="/debezium/pg.html" class="sidebar-link">PostgreSql Connector</a></li><li><a href="/debezium/mongo.html" class="sidebar-link">Mongo Connector</a></li><li><a href="/debezium/debezium_docker.html" class="sidebar-link">Debezium docker 形式部署</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>connector 作为 slave 连接 mysql, 接收 行级 binary log, 实现数据变更事件通知</p></div> <blockquote><p>connector 工作流程如下</p></blockquote> <ul><li><ol><li>snapshot record (初始化)</li></ol> <ul><li>对数据库 加全局只读锁 做快照读, 对需要监控的数据库 schema 和 数据做同步</li></ul></li> <li><ol start="2"><li>binlog record</li></ol></li></ul> <h2 id="_1-mysql-配置"><a href="#_1-mysql-配置" class="header-anchor">#</a> 1. Mysql 配置</h2> <ul><li>binlog_format
<ul><li><code>row level</code>: show variables like 'binlog_format';</li></ul></li> <li>version
<ul><li><code>5.6 or later</code>: select version()</li></ul></li> <li>GTID 可选</li> <li>创建特定用户
<ul><li>权限: GRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, REPLICATION CLIENT, LOCK TABLES ON <em>.</em> TO 'debezium' IDENTIFIED BY 'dbz';</li> <li>select: 查找行; <code>仅 snapshot 需要</code></li> <li>reload: flush 命令需要; <code>仅 snapshot 需要</code></li> <li>show databases: 获取所有 database 名称; <code>仅 snapshot 需要</code></li> <li>replication slave: connect and read binlog; <code>总是需要</code></li> <li>replication client: SHOW MASTER STATUS, SHOW SLAVE STATUS, and SHOW BINARY LOGS; <code>总是需要</code></li> <li>LOCK TABLES: 表级锁; <code>仅 aws 需要且加锁时需要</code></li></ul></li> <li>mysql 不同架构
<ul><li>单机: 没问题</li> <li>主从复制: connector 连接一台实例, 并且一直连接这台实例; 不同实例的 binlog 位置记录不同, 所以不可能切换实例</li></ul></li> <li>mysql 数据库名，表名: ([a-z,A-Z,0-9,_])</li></ul> <h2 id="_2-connector-参数"><a href="#_2-connector-参数" class="header-anchor">#</a> 2. connector 参数</h2> <ul><li>name: 唯一名称</li> <li>connector.class: 连接器的 java class, 如果 connect 中没有内置该连接器, 需要另行下载、安装该插件</li> <li>tasks.max: 默认为 1, mysql 不能改</li> <li>database.hostname: ..</li> <li>database.port: ..</li> <li>database.user: 前面提到的<code>特定用户</code></li> <li>database.password: ..</li> <li>database.whitelist: 逗号分隔白名单, 和 blacklist 无法共存</li> <li>database.blacklist: 逗号分隔黑名单, 和 whitelist 无法共存</li> <li>table.whitelist: .., 和 blacklist 无法共存</li> <li>table.blacklist: .., 和 whitelist 无法共存</li> <li>database.server.name:
<ul><li>字母或下划线开头</li> <li>mysql 集群中的唯一服务名;</li> <li>作为数据存储的 kafka topic 的前缀 (${server.name}.${db_name}.${table_name})</li></ul></li> <li>database.server.id:
<ul><li>mysql 集群中唯一服务 id</li> <li>作为 slave 同步 mysql binary log, 所以和其他 mysql slave 也要区分</li></ul></li> <li>database.history.kafka.bootstrap.servers: kafka 地址 (逗号分隔)</li> <li>database.history.kafka.topic: mysql schema 变更记录 topic
<ul><li>目前为永不删除</li></ul></li> <li>database.history.store.only.monitored.tables.ddl: true or false
<ul><li>是否监控其余表的 schema 变化并存储</li> <li>阿里云 rds 有本身的健康嗅探表, 会不停的生成 ddl 语句, 由于 <code>history topic</code> 不会删除, 会导致数据累积。
<ul><li>mysql.ha_health_check</li> <li>任务重启时, 会将 schema 拉到本地, 做数据处理.</li> <li>如果不停累积, 将会影响拉取以及处理的耗时, 导致其他一系列乱七八糟的问题</li></ul></li> <li>所以, 建议设置为 true, 只监控 table.whitelist 中 schema 变更</li></ul></li> <li>snapshot.mode: snapshot 类型
<ul><li>默认(initial)会将数据库 schema 和 所有数据生成 create 事件, 传入 kafka;</li> <li>我们选择 schema_only(只同步 schema)</li></ul></li> <li>snapshot.locking.mode
<ul><li>是否持有全局读锁</li> <li>innotdb 下, 全局锁和一致性读都可以用来备份, 而源码中两者重合了, 所以该选项可以设为 none</li></ul></li> <li>snapshot.new.tables: parallel
<ul><li>使得更改 table.whitlist 操作生效</li> <li>貌似是 <code>beta</code> 参数, 温柔修改白\黑名单, 不然会绝望的</li></ul></li> <li>decimal.handling.mode: string
<ul><li>decimal/numberic 默认转为 bytes, 暂处理为 string, 更易读、处理</li></ul></li> <li>gtid.new.channel.position: (new channel 即 GTID 前缀发生变化, 主要发生在 master 故障转移至其他 slave, 导致当前 slave 收到信息的 GTID 发生变化)
<ul><li>latest (default): 即当 debezium 再次连接时(若切换 master 之间暂停或断开)从最新位置开始同步数据</li> <li>earliest: 读取<code>新</code> GTID 且未被清理的所有数据</li></ul></li></ul> <blockquote><p>示例如下</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
    &quot;connector.class&quot;: &quot;io.debezium.connector.mysql.MySqlConnector&quot;,
    &quot;snapshot.locking.mode&quot;: &quot;none&quot;,
    &quot;database.user&quot;: &quot;debezium&quot;,
    &quot;database.server.id&quot;: &quot;222333221&quot;,
    &quot;tasks.max&quot;: &quot;1&quot;,
    &quot;database.history.kafka.bootstrap.servers&quot;: &quot;192.168.4.22:9092&quot;,
    &quot;database.history.kafka.topic&quot;: &quot;history_inventory_1&quot;,
    &quot;database.server.name&quot;: &quot;mysql_inventory_1&quot;,
    &quot;database.port&quot;: &quot;3306&quot;,
    &quot;table.whitelist&quot;: &quot;inventory.orders&quot;,
    &quot;decimal.handling.mode&quot;: &quot;string&quot;,
    &quot;database.hostname&quot;: &quot;192.168.4.23&quot;,
    &quot;database.password&quot;: &quot;dbz&quot;,
    &quot;name&quot;: &quot;mysql_inventory_1&quot;,
    &quot;database.history.store.only.monitored.tables.ddl&quot;: &quot;true&quot;,
    &quot;database.whitelist&quot;: &quot;inventory&quot;,
    &quot;snapshot.mode&quot;: &quot;schema_only&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="_3-启动流程"><a href="#_3-启动流程" class="header-anchor">#</a> 3. 启动流程</h2> <ul><li>snapshot
<ul><li>功能:
<ul><li><ol><li>设置 session 下 REPEATABLE READ 隔离级别 和全局锁 (aws 全局锁失败，针对白名单，加表级读锁)</li></ol> <ul><li><code>snapshot.locking.mode: none</code> 跳过加锁</li></ul></li> <li><ol start="2"><li>start transaction with consistent snapshot 快照读事务: 显示开启快照, 而不是像一般情况下, 第一次 select 开启快照读</li></ol></li> <li><ol start="3"><li>binglog 文件名和 position、gtid 等获取</li></ol></li> <li><ol start="4"><li>实例下数据库列表获取</li></ol></li> <li><ol start="5"><li>每个库的表列表获取</li></ol></li> <li><ol start="6"><li>connect 配置白名单数据库的 drop create 语句导入 kafka 特定 topic</li></ol></li> <li><ol start="7"><li>全局锁时解锁</li></ol> <ul><li>unlock tables 在针对全局，不会隐式提交</li> <li>针对 lock table 时，会触发隐式提交</li></ul></li> <li><ol start="8"><li>对每个表进行扫描，并对每行数据生成 create 事件，导入 kafka</li></ol> <ul><li>可通过 <code>snapshot.mode: schema_only</code> 来跳过此步骤</li></ul></li> <li><ol start="9"><li>commit</li></ol></li> <li><ol start="10"><li>再次解锁(主要针对表级锁)</li></ol></li></ul></li> <li>注意:
<ul><li><ol><li>默认情况下全局锁, 当无法获得全局锁(比如 aws rds)时, 会对每个表分别加表级读锁。</li></ol></li> <li><ol start="2"><li>但是表级锁的 unlock 命令会做隐式事务提交，导致 步骤 8 和 上面步骤不在同一事务中。</li></ol></li> <li><ol start="3"><li>那么此时的步骤 8 就脱离了快照读的范围，此时如果有数据插入:</li></ol> <ul><li>一方面会被步骤 8 数据扫描, 创建 create 事件进入 kafka;</li> <li>另一方面，会在步骤 3 获取的 binlog 位置后面插入 create 记录, 然后等到 connector 快照模式完成 进入 binglog 同步模式，就会生成 Create 事件，导致重复。（或者删除操作，binlog 删除时，指向了一个不存在的 id 等）</li></ul></li> <li><ol start="4"><li>所以表级锁的解锁放在事务提交后，这样如果数据库很大，就有的等了</li></ol></li></ul></li></ul></li></ul> <h2 id="_4-添加-table-whitelist"><a href="#_4-添加-table-whitelist" class="header-anchor">#</a> 4. 添加 table.whitelist</h2> <ul><li>旧方法:
<ul><li><ol><li>add table</li></ol></li> <li><ol start="2"><li>pasue connector</li></ol></li> <li><ol start="3"><li>delete history topic</li></ol> <ul><li>3.1 如果此流程不起作用, 可以重来一遍，然后在此位置，手动在 topic offsets 下, 此 connector 对应的 topic 分区下，手动添加 offset 信息, 将 table.whitelist 和 table.blacklist 自定义</li> <li><code>缺点</code>:
<ul><li><ol><li>可能会<code>数据重复</code>， 新的 offset 信息， pos 没有变化，重启后，再从 此 pos 位置读取数据，此位置后，已经存储的数据，就会出现重复。</li></ol></li> <li><ol start="2"><li>如果手动插入的此条 offset pos/gtid 信息过旧，那么新表会把此 offset pos/gtid 后的所有符合表白名单的数据，同步到 kafka；<code>如果数据非常多</code>，<code>比较耗时</code>；毕竟单 connector 单 task 处理数据，每秒 3300 条所有</li></ol></li></ul></li></ul></li> <li><ol start="4"><li>update config (&quot;snapshot.mode&quot;: &quot;schema_only_recovery&quot;)</li></ol></li> <li><ol start="5"><li>restart connector\task</li></ol></li> <li><ol start="6"><li>write data to new table</li></ol></li> <li><ol start="7"><li>恢复 snapshot.mode</li></ol></li></ul></li> <li>新方法:
<ul><li>功能仍在测试中 0.9.0 版本添加</li> <li>connector config 中加入 &quot;snapshot.new.tables&quot;: &quot;parallel&quot;, (off 为关闭 whitelist 实时变更)</li> <li>然后通过 restful api 依次重启 connector、task</li></ul></li> <li>重点:
<ul><li>新方法貌似不太好用, 一顿乱七八糟操作后就废了。但是把 connect 容器全部重建之后可用(重启无用), 比较诡异</li></ul></li></ul> <blockquote><p>更多信息, 比如 topic 内数据格式, 更多的数据格式兼容问题, 请查看参考文章</p></blockquote> <p>参考: <br></p> <ul><li><a href="https://debezium.io/documentation/reference/1.1/connectors/mysql.html" target="_blank" rel="noopener noreferrer">debezium mysql<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">6/10/2020, 12:21:08 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/debezium/" class="prev router-link-active">
        Debezium 介绍
      </a></span> <span class="next"><a href="/debezium/pg.html">
        PostgreSql Connector
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.d9f093e5.js" defer></script><script src="/assets/js/2.09c698bd.js" defer></script><script src="/assets/js/8.7bd05949.js" defer></script>
  </body>
</html>
